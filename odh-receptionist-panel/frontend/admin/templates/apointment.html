{% extends "base.html" %}

{% block title %}Scheduled Visitors - Admin Panel{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8">

  <!-- Header + DateTime -->
  <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
    <h2 class="text-xl sm:text-2xl font-semibold text-dark">Scheduled Visitors</h2>
    <div class="bg-white p-3 rounded-lg shadow-sm flex flex-wrap items-center justify-between w-full lg:w-auto">
      <div class="flex items-center text-sm sm:text-base">
        <i class="fas fa-calendar text-secondary mr-2"></i>
        <span id="current-date">{{ current_date }}</span>
      </div>
      <span class="hidden sm:inline mx-2">|</span>
      <div class="flex items-center text-sm sm:text-base mt-2 sm:mt-0">
        <i class="fas fa-clock text-secondary mr-2"></i>
        <span id="current-time">{{ current_time }}</span>
      </div>
    </div>
  </div>

  <!-- ✅ Flash Messages -->
  {% if flashed_messages %}
  <div id="flash-container" class="mb-4 space-y-2">
    {% for category, message in flashed_messages %}
    <div class="flash-message p-3 rounded-lg shadow
      {% if category == 'success' %} bg-green-100 border border-green-400 text-green-800
      {% elif category == 'danger' or category == 'error' %} bg-red-100 border border-red-400 text-red-800
      {% elif category == 'warning' %} bg-yellow-100 border border-yellow-400 text-yellow-800
      {% else %} bg-blue-100 border border-blue-400 text-blue-800
      {% endif %}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Scheduled Visitors Table -->
  <div class="bg-white p-5 rounded-xl shadow-sm">
    <!-- Header -->
    <div class="flex justify-between items-center pb-3 border-b border-gray-200 mb-4">
      <h3 class="text-lg font-semibold text-dark">Scheduled Appointments</h3>
      <a href="/admin/visitors/future-visitor" class="text-secondary hover:underline">View All Visitors</a>
    </div>

    <!-- Table Wrapper -->
    <div class="overflow-x-auto overflow-y-auto bg-white rounded-xl shadow-sm custom-scrollbar">
      <table id="scheduled-table" class="w-full min-w-[1000px] text-sm text-left border-collapse">
        <thead class="bg-gradient-to-r from-pink-500 via-orange-500 to-yellow-500 text-white sticky top-0 z-10">
          <tr>
            <th class="py-3 px-4 rounded-tl-lg">Name</th>
            <th class="py-3 px-4">Phone</th>
            <th class="py-3 px-4">To Meet</th>
            <th class="py-3 px-4">Purpose</th>
            <th class="py-3 px-4">City</th>
            <th class="py-3 px-4">State</th>
            <th class="py-3 px-4">Scheduled Time</th>
            <th class="py-3 px-4 rounded-tr-lg">Actions</th>
          </tr>
        </thead>
        <tbody id="scheduled-visitors-body" class="divide-y divide-gray-200">
          {% for visitor in future_visitors %}
          <tr class="hover:bg-gray-50 transition">
            <td class="py-3 px-4 font-medium text-dark">{{ visitor.masked_name }}</td>
            <td class="py-3 px-4 text-gray-600">{{ visitor.masked_phone }}</td>
            <td class="py-3 px-4 text-gray-600">{{ visitor.host }}</td>
            <td class="py-3 px-4 text-gray-600">{{ visitor.purpose }}</td>
            <td class="py-3 px-4 text-gray-600">{{ visitor.city }}</td>
            <td class="py-3 px-4 text-gray-600">{{ visitor.state }}</td>
            <td class="py-3 px-4 text-gray-600">{{ visitor.check_in_time }}</td>
            <td class="py-3 px-4">
              <a href="/admin/visitors/edit/{{ visitor.id }}"
                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                Edit
              </a>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="py-4 px-4 text-center text-gray-500 italic">
              No scheduled appointments found
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-center items-center mt-6 space-x-6">
      <button id="prev-btn-scheduled" class="px-5 py-2 rounded-2xl bg-gradient-to-r from-violet-600 to-purple-500 text-white font-semibold shadow-xl backdrop-blur-md bg-opacity-80 
             hover:scale-105 hover:shadow-2xl hover:from-violet-700 hover:to-purple-600 transition-all duration-300 ease-in-out 
             disabled:opacity-40 disabled:cursor-not-allowed">
        ⬅ Prev
      </button>

      <span id="page-info-scheduled"
        class="px-4 py-2 rounded-xl text-sm font-bold text-violet-800 bg-white/30 shadow-lg backdrop-blur-md border border-violet-200 animate-pulse">
        Page 1 of 1
      </span>

      <button id="next-btn-scheduled" class="px-5 py-2 rounded-2xl bg-gradient-to-r from-purple-500 to-violet-600 text-white font-semibold shadow-xl backdrop-blur-md bg-opacity-80 
             hover:scale-105 hover:shadow-2xl hover:from-purple-600 hover:to-violet-700 transition-all duration-300 ease-in-out 
             disabled:opacity-40 disabled:cursor-not-allowed">
        Next ➡
      </button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const rowsPerPage = 8;
    const tbody = document.getElementById("scheduled-visitors-body");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const prevBtn = document.getElementById("prev-btn-scheduled");
    const nextBtn = document.getElementById("next-btn-scheduled");
    const pageInfo = document.getElementById("page-info-scheduled");

    let currentPage = 1;
    const totalPages = Math.ceil(rows.length / rowsPerPage);

    function showPage(page) {
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      rows.forEach((row, i) => {
        row.style.display = (i >= start && i < end) ? "" : "none";
      });
      pageInfo.textContent = `Page ${page} of ${totalPages}`;
      prevBtn.disabled = page === 1;
      nextBtn.disabled = page === totalPages;
    }

    prevBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        showPage(currentPage);
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        showPage(currentPage);
      }
    });

    showPage(currentPage); // initialize first page
  });

  // Header Date/Time update
  function updateDateTime() {
    const now = new Date();
    document.getElementById('current-date').textContent =
      now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US');
  }
  updateDateTime();
  setInterval(updateDateTime, 1000);
</script>
{% endblock %}
