


# from fastapi import FastAPI, Request, Depends, HTTPException, status, Form, Cookie
# from fastapi.responses import HTMLResponse, RedirectResponse
# from fastapi.templating import Jinja2Templates
# from sqlalchemy.ext.asyncio import AsyncSession
# from sqlalchemy.future import select
# from sqlalchemy import func
# import sqlalchemy as sa
# from datetime import timedelta,datetime
# from typing import Optional
# from zoneinfo import ZoneInfo

# from jose import JWTError, jwt
# from app.models import User, Visitor
# from app.database import get_db
# from app.security import authenticate_user, create_access_token,SECRET_KEY, ALGORITHM,verify_access_token

# from app import crud, schemas
# from app.schemas import UserUpdate
# from app.auth import get_current_user
# from app.utils import mask_name, mask_email,mask_phone,get_initials,mask_address,_send_to_gateway,generate_otp,verify_otp


# from app.schemas import SMSRequest  # Add this import if SMSRequest is defined in schemas.py
# from app.settings import Settings, get_settings
# from app import models
# from fastapi.responses import JSONResponse







# IST = ZoneInfo("Asia/Kolkata")

# app = FastAPI(title="Receptionist Panel")

# # Templates
# login_templates = Jinja2Templates(directory="frontend")
# reception_templates = Jinja2Templates(directory="frontend/reception/templates")
# admin_templates = Jinja2Templates(directory="frontend/admin/templates")

# # ========================================== USER MANAGEMENT ENDPOINTS ===================================================


# # ---------------- LOGIN PAGE ---------------- #

# # @app.get("/", response_class=HTMLResponse)
# # async def login_page(request: Request,  access_token: Optional[str] = Cookie(None)):

# #     if access_token:

# #         redirect_url = "/admin/dashboard"

# #         response = RedirectResponse(url=redirect_url, status_code=status.HTTP_302_FOUND)

# #         return response

    

   
# #     return login_templates.TemplateResponse("login.html", {"request": request})




# @app.get("/", response_class=HTMLResponse)
# async def login_page(
#     request: Request,
#     access_token: Optional[str] = Cookie(None)
# ):
#     if access_token:
#         # Decode the access token
#         token_data = verify_access_token(access_token)
#         if token_data:
#             role = token_data.get("role")

#             if role == "admin":
#                 redirect_url = "/admin/dashboard"
#                 response = RedirectResponse(url=redirect_url, status_code=status.HTTP_302_FOUND)
#                 return response

#             elif role == "receptionist":
#                 redirect_url = "/receptionist/dashboard"
#                 response = RedirectResponse(url=redirect_url, status_code=status.HTTP_302_FOUND)
#                 return response

#     # If no valid access token, show login page (with no caching)
#     response = login_templates.TemplateResponse("login.html", {"request": request})
#     response.headers["Cache-Control"] = "no-store"
#     response.headers["Pragma"] = "no-cache"
#     return response







# @app.post("/login", response_class=HTMLResponse)
# async def login(
#     request: Request,
#     username: str = Form(...),
#     password: str = Form(...),
#     db: AsyncSession = Depends(get_db)
# ):
    
#     # print(request)
#     # Authenticate user
#     user = await authenticate_user(db, username, password)
#     if not user:
#         return login_templates.TemplateResponse(
#             "login.html",
#             {"request": request, "error": "Invalid credentials"}
#         )

#     # Create access token
#     access_token_expires = timedelta(minutes=30)
#     access_token = create_access_token(
#         data={"sub": user.username, "role": user.role},
#         expires_delta=access_token_expires
#     )

#     # ✅ Choose dashboard by role
#     if user.role == "admin":
#         redirect_url = "/admin/dashboard"
#     elif user.role == "receptionist":
#         redirect_url = "/receptionist/dashboard"
#     else:
#         raise HTTPException(status_code=403, detail="Unauthorized role")

#     # ✅ Redirect to correct dashboard
#     response = RedirectResponse(url=redirect_url, status_code=status.HTTP_302_FOUND)
#     response.set_cookie(
#         key="access_token",
#         value=access_token,
#         httponly=True,
#         max_age=1800
#     )
#     return response








# # ========================================== USER MANAGEMENT ENDPOINTS ===================================================





# @app.get("/admin/users", response_class=HTMLResponse)
# async def admin_users(
#     request: Request,
#     page: int = 1,
#     db: AsyncSession = Depends(get_db),
#     access_token: Optional[str] = Cookie(None)
# ):
#     current_user, redirect = await require_admin(request, db, access_token)
#     if redirect:
#         return redirect
    
#     per_page = 10
#     users, total_pages = await crud.get_users_paginated(db, page, per_page)
    
#     return admin_templates.TemplateResponse(
#         "user_management.html",
#         {
#             "request": request,
#             "current_user": current_user,
#             "users": users,
#             "page": page,
#             "total_pages": total_pages
#         }
#     )




# @app.post("/admin/users", response_class=HTMLResponse)
# async def admin_create_user(
#     request: Request,
#     username: str = Form(...),
#     password: str = Form(...),
#     role: str = Form(...),
#     db: AsyncSession = Depends(get_db),
#     access_token: Optional[str] = Cookie(None)
# ):
#     current_user, redirect = await require_admin(request, db, access_token)
#     if redirect:
#         return redirect

#     # Check if username already exists
#     result = await db.execute(select(User).where(User.username == username))
#     existing_user = result.scalars().first()
#     if existing_user:
#         users = await crud.get_users(db)
#         return admin_templates.TemplateResponse(
#             "user_management.html",
#             {
#                 "request": request,
#                 "current_user": current_user,
#                 "users": users,
#                 "error": "Username already exists"
#             }
#         )

#     # Create new user
#     hashed_password = crud.hash_password(password)
#     new_user = User(
#         username=username,
#         password_hash=hashed_password,
#         role=role
#     )

#     db.add(new_user)
#     await db.commit()
#     await db.refresh(new_user)

#     return RedirectResponse(url="/admin/users", status_code=status.HTTP_303_SEE_OTHER)







# @app.put("/admin/users/manage/{user_id}", response_class=HTMLResponse)
# async def admin_update_user(
#     request: Request,
#     user_id: int,
#     username: str = Form(None),
#     password: str = Form(None),
#     role: str = Form(None),
#     db: AsyncSession = Depends(get_db),
#     access_token: Optional[str] = Cookie(None)
# ):
#     current_user, redirect = await require_admin(request, db, access_token)
#     if redirect:
#         return redirect

#     # Get pagination parameters
#     page = int(request.query_params.get("page", 1))
#     per_page = 10
    
#     # Get the user to update
#     result = await db.execute(select(User).where(User.id == user_id))
#     user = result.scalars().first()
    
#     if not user:
#         users, total_pages = await crud.get_users_paginated(db, page, per_page)
#         return admin_templates.TemplateResponse(
#             "user_management.html",
#             {
#                 "request": request,
#                 "current_user": current_user,
#                 "users": users,
#                 "page": page,
#                 "total_pages": total_pages,
#                 "error": "User not found"
#             }
#         )

#     # Update fields if provided
#     if username:
#         # Check if new username is already taken by another user
#         result = await db.execute(select(User).where(User.username == username, User.id != user_id))
#         existing_user = result.scalars().first()
#         if existing_user:
#             users, total_pages = await crud.get_users_paginated(db, page, per_page)
#             return admin_templates.TemplateResponse(
#                 "user_management.html",
#                 {
#                     "request": request,
#                     "current_user": current_user,
#                     "users": users,
#                     "page": page,
#                     "total_pages": total_pages,
#                     "error": "Username already taken"
#                 }
#             )
#         user.username = username
    
#     if password:
#         user.password_hash = crud.hash_password(password)
    
#     if role:
#         user.role = role

#     await db.commit()
#     await db.refresh(user)

#     users, total_pages = await crud.get_users_paginated(db, page, per_page)
#     return admin_templates.TemplateResponse(
#         "user_management.html",
#         {
#             "request": request,
#             "current_user": current_user,
#             "users": users,
#             "page": page,
#             "total_pages": total_pages,
#             "success": "User updated successfully!"
#         }
#     )






# @app.delete("/admin/users/{user_id}", response_class=HTMLResponse)
# async def admin_delete_user(
#     request: Request,
#     user_id: int,
#     db: AsyncSession = Depends(get_db),
#     access_token: Optional[str] = Cookie(None)
# ):
#     current_user, redirect = await require_admin(request, db, access_token)
#     if redirect:
#         return redirect

#     # Get the user to delete
#     result = await db.execute(select(User).where(User.id == user_id))
#     user = result.scalars().first()
    
#     if not user:
#         users = await crud.get_users(db)
#         return admin_templates.TemplateResponse(
#             "user_management.html",
#             {
#                 "request": request,
#                 "current_user": current_user,
#                 "users": users,
#                 "error": "User not found"
#             }
#         )

#     # Prevent self-deletion
#     if user.id == current_user["id"]:
#         users = await crud.get_users(db)
#         return admin_templates.TemplateResponse(
#             "user_management.html",
#             {
#                 "request": request,
#                 "current_user": current_user,
#                 "users": users,
#                 "error": "Cannot delete your own account"
#             }
#         )

#     await db.delete(user)
#     await db.commit()

#     return RedirectResponse(url="/admin/users", status_code=status.HTTP_303_SEE_OTHER)

# # Add this to your sidebar menu in base.html
# # <li>
# #     <a href="/admin/users"
# #         class="flex items-center p-3 rounded-lg 
# #        {% if request.url.path == '/admin/users' %}bg-secondary text-white{% else %}text-dark hover:bg-secondary hover:text-white{% endif %}">
# #         <i class="fas fa-user-cog w-5 text-center mr-2"></i> User Management
# #     </a>
# # </li>



# # ------------------------------------------------ CURRENT USER HELPER --------------------------------------------- #



# async def require_receptionist(request, db, access_token):
#     current_user = await get_current_user(request=request, db=db, access_token=access_token)
#     if not current_user:
#         return None, RedirectResponse(url="/", status_code=status.HTTP_302_FOUND)

#     if current_user["role"] != "receptionist":
#         raise HTTPException(status_code=403, detail="Access forbidden")

#     return current_user, None








# # async def require_admin(request: Request, db: AsyncSession, access_token: Optional[str] = Cookie(None)):
# #     current_user = await get_current_user(request=request, db=db, access_token=access_token)
# #     if not current_user:
# #         return None, RedirectResponse(url="/", status_code=status.HTTP_302_FOUND)

# #     if current_user["role"] != "admin":
# #         raise HTTPException(status_code=403, detail="Access forbidden")

# #     return current_user, None







# async def require_admin(request: Request, db: AsyncSession, access_token: Optional[str]):
#     if not access_token:
#         return None, RedirectResponse(url="/login", status_code=302)

#     try:
#         payload = jwt.decode(access_token, SECRET_KEY, algorithms=[ALGORITHM])
#         username: str = payload.get("sub")
#         role: str = payload.get("role")

#         if username is None or role != "admin":
#             return None, RedirectResponse(url="/login", status_code=302)

#     except JWTError:
#         return None, RedirectResponse(url="/login", status_code=302)

#     result = await db.execute(select(User).where(User.username == username))
#     user = result.scalars().first()
#     if not user:
#         return None, RedirectResponse(url="/login", status_code=302)

#     return user, None




# #================================================================ ADMIN DASHBOARD ===============================================================





# # @app.get("/admin/dashboard", response_class=HTMLResponse)
# # async def admin_dashboard(
# #     request: Request,
# #     db: AsyncSession = Depends(get_db),
# #     access_token: Optional[str] = Cookie(None)
# # ):
    
# #     print("acces token is",access_token)
# #     current_user, redirect = await require_admin(request, db, access_token)

# #     print("current user is",current_user)
# #     if redirect:
# #         return redirect

# #     today_visitors = await crud.count_today_visitors(db)
# #     # waiting_visitors = await crud.count_waiting_visitors(db)
# #     # checked_in_visitors = await crud.count_checked_in_visitors(db)
# #     recent_visitors = await crud.get_recent_visitors(db, limit=10)

# #     return admin_templates.TemplateResponse(
# #         "index.html",
# #         {
# #             "request": request,
# #             "current_user": current_user,
# #             "today_visitors": today_visitors,

# #             "recent_visitors": recent_visitors,
# #         }
# #     )




# @app.get("/admin/dashboard", response_class=HTMLResponse)
# async def admin_dashboard(
#     request: Request,
#     db: AsyncSession = Depends(get_db),
#     access_token: Optional[str] = Cookie(None)
# ):
#     current_user, redirect = await require_admin(request, db, access_token)

#     if redirect:
#         return redirect  # ❌ Agar token missing/invalid hai to login bhej do

#     today_visitors = await crud.count_today_visitors(db)
#     recent_visitors = await crud.get_recent_visitors(db, limit=10)

#     return admin_templates.TemplateResponse(
#         "index.html",
#         {
#             "request": request,
#             "current_user": current_user,
#             "today_visitors": today_visitors,
#             "recent_visitors": recent_visitors,
#         }
#     )





# @app.get("/admin/visitors/all", response_class=HTMLResponse)
# async def admin_all_visitors(
#     request: Request,
#     page: int = 1,
#     per_page: int = 10,
#     db: AsyncSession = Depends(get_db),
#     access_token: Optional[str] = Cookie(None),
# ):
#     current_user, redirect = await require_admin(request, db, access_token)
#     if redirect:
#         return redirect

#     # Count total visitors
#     result = await db.execute(sa.select(func.count(Visitor.id)))
#     total_visitors = result.scalar()

#     # Pagination
#     offset = (page - 1) * per_page
#     query = await db.execute(
#         sa.select(Visitor).order_by(Visitor.check_in_time.desc()).offset(offset).limit(per_page)
#     )
#     visitors = query.scalars().all()

#     total_pages = (total_visitors + per_page - 1) // per_page

#     return admin_templates.TemplateResponse(
#         "visitor.html",
#         {
#             "request": request,
#             "current_user": current_user,
#             "all_visitors": visitors,
#             "page": page,
#             "total_pages": total_pages,
#             "per_page": per_page,
#             "current_date": datetime.utcnow().strftime("%A, %B %d, %Y"),
#             "current_time": datetime.utcnow().strftime("%H:%M:%S"),
#         },
#     )





# # @app.get("/admin/visitors/{visitor_id}/edit")
# # async def admin_edit_visitor_page(
# #     request: Request,
# #     visitor_id: int,
# #     db: AsyncSession = Depends(get_db),
# #     access_token: Optional[str] = Cookie(None),
# # ):
# #     current_user = await get_current_user(request, db, access_token)
# #     if not current_user or current_user["role"] != "admin":
# #         return RedirectResponse(url="/", status_code=status.HTTP_302_FOUND)

# #     result = await db.execute(select(Visitor).where(Visitor.id == visitor_id))
# #     visitor = result.scalars().first()

# #     if not visitor:
# #         raise HTTPException(status_code=404, detail="Visitor not found")

# #     return admin_templates.TemplateResponse(
# #         "visitor_edit.html",
# #         {
# #             "request": request,
# #             "visitor": visitor
# #         }
# #     )







# #===============================================RECEPTIONIST DASHBOARD ==============================================================


# @app.get("/receptionist/dashboard", response_class=HTMLResponse)
# async def receptionist_dashboard(
#     request: Request,
#     db: AsyncSession = Depends(get_db),
#     access_token: Optional[str] = Cookie(None)
# ):
#     current_user, redirect = await require_receptionist(request, db, access_token)
#     if redirect:
#         return redirect

#     today_visitors = await crud.count_today_visitors(db)
#     # waiting_visitors = await crud.count_waiting_visitors(db)
#     # checked_in_visitors = await crud.count_checked_in_visitors(db)
#     recent_visitors = await crud.get_recent_visitors(db, limit=10)

    
#     masked_visitors = []
#     for v in recent_visitors:
#         masked_visitors.append({
#            "id": v.id,
#             "name": mask_name(v.name),
#             "email": mask_email(v.email),
#             "phone": mask_phone(v.phone),
#             "company": v.company,
#             "host": v.host,
#             "address": mask_address(v.address),
#             "check_in_time": v.check_in_time,
#         })


#     # render template
            
#     return reception_templates.TemplateResponse(
#         "index.html",
#         {
#             "request": request,
#             "current_user": current_user,
#             "today_visitors": today_visitors,

#             "recent_visitors": masked_visitors,
#         }
#     )



# # ========================================== RECEPTIONIST VISITOR ENDPOINTS ===============================================





# # @app.get("/receptionist/visitors/all", response_class=HTMLResponse)
# # async def receptionist_all_visitors(
# #     request: Request,
# #     page: int = 1,
# #     per_page: int = 10,
# #     db: AsyncSession = Depends(get_db),
# #     access_token: Optional[str] = Cookie(None),
# # ):
# #     current_user, redirect = await require_receptionist(request, db, access_token)
# #     if redirect:
# #         return redirect

# #     # Count total visitors
# #     result = await db.execute(sa.select(func.count(Visitor.id)))
# #     total_visitors = result.scalar()

# #     # Pagination
# #     offset = (page - 1) * per_page
# #     query = await db.execute(
# #         sa.select(Visitor).order_by(Visitor.check_in_time.desc()).offset(offset).limit(per_page)
# #     )
# #     visitors = query.scalars().all()

# #     total_pages = (total_visitors + per_page - 1) // per_page

# #     return reception_templates.TemplateResponse(
# #         "visitor.html",
# #         {
# #             "request": request,
# #             "current_user": current_user,
# #             "all_visitors": visitors,
# #             "page": page,
# #             "total_pages": total_pages,
# #             "per_page": per_page,
# #             "current_date": datetime.utcnow().strftime("%A, %B %d, %Y"),
# #             "current_time": datetime.utcnow().strftime("%H:%M:%S"),
# #         },
# #     )





# # # Receptionist visitors endpoint
# # @app.get("/receptionist/visitors/all", response_class=HTMLResponse)
# # async def receptionist_all_visitors(
# #     request: Request,
# #     page: int = 1,
# #     per_page: int = 10,
# #     db: AsyncSession = Depends(get_db),
# #     access_token: Optional[str] = Cookie(None),
# # ):
# #     # Receptionist auth check
# #     current_user, redirect = await require_receptionist(request, db, access_token)
# #     if redirect:
# #         return redirect

# #     # Count total visitors
# #     result = await db.execute(sa.select(func.count(Visitor.id)))
# #     total_visitors = result.scalar()

# #     # Pagination
# #     offset = (page - 1) * per_page
# #     query = await db.execute(
# #         sa.select(Visitor).order_by(Visitor.check_in_time.desc()).offset(offset).limit(per_page)
# #     )
# #     visitors = query.scalars().all()

# #     # Masked data
# #     visitors_data = []
# #     for visitor in visitors:
# #         visitors_data.append({
# #             "id": visitor.id,
# #             "masked_name": mask_name(visitor.name),
# #             "initials": get_initials(visitor.name),
# #             "company": visitor.company,
# #             "masked_email": mask_email(visitor.email),
# #             "masked_phone": mask_phone(visitor.phone),
# #             "host": visitor.host,
# #             "masked_address": mask_address(visitor.address),
# #             "check_in_time": visitor.check_in_time,
# #         })

# #     total_pages = (total_visitors + per_page - 1) // per_page

# #     return reception_templates.TemplateResponse(
# #         "visitor.html",
# #         {
# #             "request": request,
# #             "current_user": current_user,
# #             "all_visitors": visitors_data,
# #             "page": page,
# #             "total_pages": total_pages,
# #             "per_page": per_page,
# #             "current_date": datetime.utcnow().strftime("%A, %B %d, %Y"),
# #             "current_time": datetime.utcnow().strftime("%H:%M:%S"),
# #         },
# #     )


# # Receptionist visitors endpoint - Sorted by check_in_time descending
# @app.get("/receptionist/visitors/all", response_class=HTMLResponse)
# async def receptionist_all_visitors(
#     request: Request,
#     page: int = 1,
#     per_page: int = 10,
#     db: AsyncSession = Depends(get_db),
#     access_token: Optional[str] = Cookie(None),
# ):
#     # Receptionist auth check
#     current_user, redirect = await require_receptionist(request, db, access_token)
#     if redirect:
#         return redirect

#     # Count total visitors
#     result = await db.execute(sa.select(func.count(Visitor.id)))
#     total_visitors = result.scalar()

#     # Ensure page is within valid range
#     if page < 1:
#         page = 1
#     total_pages = max(1, (total_visitors + per_page - 1) // per_page)
#     if page > total_pages:
#         page = total_pages

#     # Pagination - Order by check_in_time descending (newest first)
#     offset = (page - 1) * per_page
#     query = await db.execute(
#         sa.select(Visitor)
#         .order_by(Visitor.check_in_time.desc())  # Newest visitors first
#         .offset(offset)
#         .limit(per_page)
#     )
#     visitors = query.scalars().all()

#     # Debug: Print visitor times to verify order
#     print(f"Page {page} visitors:")
#     for i, visitor in enumerate(visitors):
#         print(f"  {i+1}. {visitor.check_in_time} - {visitor.name}")

#     # Masked data
#     visitors_data = []
#     for visitor in visitors:
#         # Format check_in_time to readable format
#         check_in_time_formatted = visitor.check_in_time.strftime("%d %b %Y, %I:%M %p")
        
#         visitors_data.append({
#             "id": visitor.id,
#             "masked_name": mask_name(visitor.name),
#             "initials": get_initials(visitor.name),
#             "company": visitor.company,
#             "masked_email": mask_email(visitor.email),
#             "masked_phone": mask_phone(visitor.phone),
#             "host": visitor.host,
#             "masked_address": mask_address(visitor.address),
#             "check_in_time": check_in_time_formatted,
#             "check_in_time_raw": visitor.check_in_time.isoformat(),
#         })

#     # Get current date and time
#     current_time = datetime.now()
#     current_date_display = current_time.strftime("%A, %B %d, %Y")
#     current_time_display = current_time.strftime("%H:%M:%S")

#     return reception_templates.TemplateResponse(
#         "visitor.html",
#         {
#             "request": request,
#             "current_user": current_user,
#             "all_visitors": visitors_data,
#             "page": page,
#             "total_pages": total_pages,
#             "per_page": per_page,
#             "total_visitors": total_visitors,
#             "current_date": current_date_display,
#             "current_time": current_time_display,
#         },
#     )

# # @app.post("/receptionist/visitors/check-in", response_class=HTMLResponse)
# # async def receptionist_check_in_submit(
# #     request: Request,
# #     name: str = Form(...),
# #     company: str = Form(None),
# #     email: str = Form(None),
# #     phone: str = Form(...),
# #     date: str = Form(""),
# #     time: str = Form(""),
# #     host: str = Form(...),
# #     purpose: str = Form(...),
# #     address: str =Form(...),
# #     db: AsyncSession = Depends(get_db),
# #     access_token: Optional[str] = Cookie(None),
# # ):
# #     current_user, redirect = await require_receptionist(request, db, access_token)
# #     if redirect:
# #         return redirect

# #     if date.strip() and time.strip():
# #         try:
# #             check_in_time = datetime.strptime(f"{date} {time}", "%Y-%m-%d %H:%M")
# #         except ValueError:
# #             check_in_time = datetime.now(IST)
# #     else:
# #         check_in_time = datetime.now(IST)

# #     check_in_time = check_in_time.replace(tzinfo=None)

# #     new_visitor = Visitor(
# #         name=name,
# #         company=company,
# #         email=email,
# #         phone=phone,
# #         host=host,
# #         purpose=purpose,
# #         check_in_time=check_in_time,
# #         address=address,
# #         created_by=current_user["id"],
# #     )

# #     db.add(new_visitor)
# #     await db.commit()
# #     await db.refresh(new_visitor)

# #     #     # ✅ OTP once used → delete
# #     # del OtpStore[phone]

# #     return RedirectResponse(url="/receptionist/visitors/all", status_code=status.HTTP_303_SEE_OTHER)


# @app.post("/receptionist/visitors/check-in", response_class=HTMLResponse)
# async def receptionist_check_in_submit(
#     request: Request,
#     name: str = Form(...),
#     company: str = Form(None),
#     email: str = Form(None),
#     phone: str = Form(...),
#     otp: str = Form(...),
#     date: str = Form(...),
#     time: str = Form(...),
#     host: str = Form(...),
#     purpose: str = Form(...),
#     address: str = Form(None),
#     db: AsyncSession = Depends(get_db),
#     access_token: Optional[str] = Cookie(None),
# ):
#     current_user, redirect = await require_receptionist(request, db, access_token)
#     if redirect:
#         return redirect



#     # Parse date and time
#     if date.strip() and time.strip():
#         try:
#             check_in_time = datetime.strptime(f"{date} {time}", "%Y-%m-%d %H:%M")
#             print(f"Parsed date/time: {check_in_time}")  # Debug
#         except ValueError:
#             print("Date parsing failed, using current time")  # Debug
#             check_in_time = datetime.now(IST)
#     else:
#         print("Using current time")  # Debug
#         check_in_time = datetime.now(IST)

#     check_in_time = check_in_time.replace(tzinfo=None)

#     # Create new visitor
#     new_visitor = Visitor(
#         name=name,
#         company=company,
#         email=email,
#         phone=phone,
#         host=host,
#         purpose=purpose,
#         address=address,
#         check_in_time=check_in_time,
#         created_by=current_user["id"],
#     )

#     db.add(new_visitor)
#     await db.commit()
#     await db.refresh(new_visitor)

#     print(f"Visitor {name} checked in successfully")  # Debug

#     return RedirectResponse(url="/receptionist/visitors/all", status_code=status.HTTP_303_SEE_OTHER)

# # ----------------------------------  SMS OTP ----------------------------------------

# @app.post("/sms/send")
# async def send_sms(payload: SMSRequest, settings: Settings = Depends(get_settings)):
#     return await _send_to_gateway(payload, settings)




# @app.post("/receptionist/visitors/verify-otp")
# async def verify_otp_endpoint(phone: str = Form(...), otp: str = Form(...)):


#     res=verify_otp(phone, otp)

#     print("is otp verified",otp,res)
#     if res:
#         return {"ok": True, "message": "OTP verified successfully"}
#     return JSONResponse(content={"ok": False, "message": "OTP verification failed"})


# @app.get("/logout")
# async def logout():
#     response = RedirectResponse(url="/", status_code=status.HTTP_302_FOUND)
#     response.delete_cookie("access_token")
#     return response













from fastapi import FastAPI, Request, Depends, HTTPException, status, Form, Cookie
from fastapi.responses import HTMLResponse, RedirectResponse
from fastapi.templating import Jinja2Templates
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
from sqlalchemy import func
import sqlalchemy as sa
from sqlalchemy.orm import Session
from datetime import timedelta,datetime
from typing import Optional
from zoneinfo import ZoneInfo

from jose import JWTError, jwt
from app.models import User, Visitor,OTP
from app.database import get_db
from app.security import authenticate_user, create_access_token,SECRET_KEY, ALGORITHM,verify_access_token

from app import crud, schemas
from app.schemas import UserUpdate
from app.auth import get_current_user
from app.utils import mask_name, mask_email,mask_phone,get_initials,mask_address,_send_to_gateway,get_flashed_messages,verify_and_delete_otp,generate_and_store_otp


from app.schemas import SMSRequest  # Add this import if SMSRequest is defined in schemas.py
from app.settings import Settings, get_settings
from app import models,utils
from fastapi.responses import JSONResponse
from starlette.middleware.sessions import SessionMiddleware
import os
from app.utils import flash
from datetime import datetime







IST = ZoneInfo("Asia/Kolkata")

app = FastAPI(title="Receptionist Panel")

# Templates
login_templates = Jinja2Templates(directory="frontend")
reception_templates = Jinja2Templates(directory="frontend/reception/templates")
admin_templates = Jinja2Templates(directory="frontend/admin/templates")


#====================== flash msg key ======================

SECRET_KEY = os.environ.get("SECRET_KEY", "logan")
app.add_middleware(SessionMiddleware, secret_key=SECRET_KEY)








# ========================================== USER MANAGEMENT ENDPOINTS ===================================================


# ---------------- LOGIN PAGE ---------------- #

# @app.get("/", response_class=HTMLResponse)
# async def login_page(request: Request,  access_token: Optional[str] = Cookie(None)):

#     if access_token:

#         redirect_url = "/admin/dashboard"

#         response = RedirectResponse(url=redirect_url, status_code=status.HTTP_302_FOUND)

#         return response

    

   
#     return login_templates.TemplateResponse("login.html", {"request": request})




@app.get("/", response_class=HTMLResponse)
async def login_page(
    request: Request,
    access_token: Optional[str] = Cookie(None)
):
    if access_token:
        # Decode the access token
        token_data = verify_access_token(access_token)
        if token_data:
            role = token_data.get("role")

            if role == "admin":
                redirect_url = "/admin/dashboard"
                response = RedirectResponse(url=redirect_url, status_code=status.HTTP_302_FOUND)
                return response

            elif role == "receptionist":
                redirect_url = "/receptionist/dashboard"
                response = RedirectResponse(url=redirect_url, status_code=status.HTTP_302_FOUND)
                return response

    # If no valid access token, show login page (with no caching)
    response = login_templates.TemplateResponse("login.html", {"request": request})
    response.headers["Cache-Control"] = "no-store"
    response.headers["Pragma"] = "no-cache"
    return response







@app.post("/login", response_class=HTMLResponse)
async def login(
    request: Request,
    username: str = Form(...),
    password: str = Form(...),
    db: AsyncSession = Depends(get_db)
):
    
    # print(request)
    # Authenticate user
    user = await authenticate_user(db, username, password)
    if not user:
        return login_templates.TemplateResponse(
            "login.html",
            {"request": request, "error": "Invalid credentials"}
        )

    # Create access token
    access_token_expires = timedelta(minutes=30)
    access_token = create_access_token(
        data={"sub": user.username, "role": user.role},
        expires_delta=access_token_expires
    )

    # ✅ Choose dashboard by role
    if user.role == "admin":
        redirect_url = "/admin/dashboard"
    elif user.role == "receptionist":
        redirect_url = "/receptionist/dashboard"
    else:
        raise HTTPException(status_code=403, detail="Unauthorized role")

    # ✅ Redirect to correct dashboard
    response = RedirectResponse(url=redirect_url, status_code=status.HTTP_302_FOUND)
    response.set_cookie(
        key="access_token",
        value=access_token,
        httponly=True,
        max_age=1800
    )
    return response








# ========================================== USER MANAGEMENT ENDPOINTS ===================================================





@app.get("/admin/users", response_class=HTMLResponse)
async def admin_users(
    request: Request,
    page: int = 1,
    db: AsyncSession = Depends(get_db),
    access_token: Optional[str] = Cookie(None)
):
    current_user, redirect = await require_admin(request, db, access_token)
    if redirect:
        return redirect
    
    per_page = 10
    users, total_pages = await crud.get_users_paginated(db, page, per_page)
    
    return admin_templates.TemplateResponse(
        "user_management.html",
        {
            "request": request,
            "current_user": current_user,
            "users": users,
            "page": page,
            "total_pages": total_pages
        }
    )




@app.post("/admin/users", response_class=HTMLResponse)
async def admin_create_user(
    request: Request,
    username: str = Form(...),
    password: str = Form(...),
    role: str = Form(...),
    db: AsyncSession = Depends(get_db),
    access_token: Optional[str] = Cookie(None)
):
    current_user, redirect = await require_admin(request, db, access_token)
    if redirect:
        return redirect

    # Check if username already exists
    result = await db.execute(select(User).where(User.username == username))
    existing_user = result.scalars().first()
    if existing_user:
        users = await crud.get_users(db)
        return admin_templates.TemplateResponse(
            "user_management.html",
            {
                "request": request,
                "current_user": current_user,
                "users": users,
                "error": "Username already exists"
            }
        )

    # Create new user
    hashed_password = crud.hash_password(password)
    new_user = User(
        username=username,
        password_hash=hashed_password,
        role=role
    )

    db.add(new_user)
    await db.commit()
    await db.refresh(new_user)

    return RedirectResponse(url="/admin/users", status_code=status.HTTP_303_SEE_OTHER)







@app.put("/admin/users/manage/{user_id}", response_class=HTMLResponse)
async def admin_update_user(
    request: Request,
    user_id: int,
    username: str = Form(None),
    password: str = Form(None),
    role: str = Form(None),
    db: AsyncSession = Depends(get_db),
    access_token: Optional[str] = Cookie(None)
):
    current_user, redirect = await require_admin(request, db, access_token)
    if redirect:
        return redirect

    # Get pagination parameters
    page = int(request.query_params.get("page", 1))
    per_page = 10
    
    # Get the user to update
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalars().first()
    
    if not user:
        users, total_pages = await crud.get_users_paginated(db, page, per_page)
        return admin_templates.TemplateResponse(
            "user_management.html",
            {
                "request": request,
                "current_user": current_user,
                "users": users,
                "page": page,
                "total_pages": total_pages,
                "error": "User not found"
            }
        )

    # Update fields if provided
    if username:
        # Check if new username is already taken by another user
        result = await db.execute(select(User).where(User.username == username, User.id != user_id))
        existing_user = result.scalars().first()
        if existing_user:
            users, total_pages = await crud.get_users_paginated(db, page, per_page)
            return admin_templates.TemplateResponse(
                "user_management.html",
                {
                    "request": request,
                    "current_user": current_user,
                    "users": users,
                    "page": page,
                    "total_pages": total_pages,
                    "error": "Username already taken"
                }
            )
        user.username = username
    
    if password:
        user.password_hash = crud.hash_password(password)
    
    if role:
        user.role = role

    await db.commit()
    await db.refresh(user)

    users, total_pages = await crud.get_users_paginated(db, page, per_page)
    return admin_templates.TemplateResponse(
        "user_management.html",
        {
            "request": request,
            "current_user": current_user,
            "users": users,
            "page": page,
            "total_pages": total_pages,
            "success": "User updated successfully!"
        }
    )






@app.delete("/admin/users/{user_id}", response_class=HTMLResponse)
async def admin_delete_user(
    request: Request,
    user_id: int,
    db: AsyncSession = Depends(get_db),
    access_token: Optional[str] = Cookie(None)
):
    current_user, redirect = await require_admin(request, db, access_token)
    if redirect:
        return redirect

    # Get the user to delete
    result = await db.execute(select(User).where(User.id == user_id))
    user = result.scalars().first()
    
    if not user:
        users = await crud.get_users(db)
        return admin_templates.TemplateResponse(
            "user_management.html",
            {
                "request": request,
                "current_user": current_user,
                "users": users,
                "error": "User not found"
            }
        )

    # Prevent self-deletion
    # Prevent self-deletion
    if user.id == current_user.id:
        users = await crud.get_users(db)
        return admin_templates.TemplateResponse(
            "user_management.html",
            {
                "request": request,
                "current_user": current_user,
                "users": users,
                "error": "Cannot delete your own account"
            }
        )


    await db.delete(user)
    await db.commit()

    return RedirectResponse(url="/admin/users", status_code=status.HTTP_303_SEE_OTHER)



# ------------------------------------------------ CURRENT USER HELPER --------------------------------------------- #



async def require_receptionist(request, db, access_token):
    current_user = await get_current_user(request=request, db=db, access_token=access_token)
    if not current_user:
        return None, RedirectResponse(url="/", status_code=status.HTTP_302_FOUND)

    if current_user["role"] != "receptionist":
        raise HTTPException(status_code=403, detail="Access forbidden")

    return current_user, None










async def require_admin(request: Request, db: AsyncSession, access_token: Optional[str]):
    if not access_token:
        return None, RedirectResponse(url="/login", status_code=302)

    try:
        payload = jwt.decode(access_token, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")
        role: str = payload.get("role")

        if username is None or role != "admin":
            return None, RedirectResponse(url="/login", status_code=302)

    except JWTError:
        return None, RedirectResponse(url="/login", status_code=302)

    result = await db.execute(select(User).where(User.username == username))
    user = result.scalars().first()
    if not user:
        return None, RedirectResponse(url="/login", status_code=302)

    return user, None




#================================================================ ADMIN DASHBOARD ===============================================================








@app.get("/admin/dashboard", response_class=HTMLResponse)
async def admin_dashboard(
    request: Request,
    db: AsyncSession = Depends(get_db),
    access_token: Optional[str] = Cookie(None)
):
    current_user, redirect = await require_admin(request, db, access_token)

    if redirect:
        return redirect  # ❌ Agar token missing/invalid hai to login bhej do

    today_visitors = await crud.count_today_visitors(db)
    recent_visitors = await crud.get_recent_visitors(db, limit=10)

    return admin_templates.TemplateResponse(
        "index.html",
        {
            "request": request,
            "current_user": current_user,
            "today_visitors": today_visitors,
            "recent_visitors": recent_visitors,
        }
    )





@app.get("/admin/visitors/all", response_class=HTMLResponse)
async def admin_all_visitors(
    request: Request,
    # page: int = 1,
    # per_page: int = 10,
    db: AsyncSession = Depends(get_db),
    access_token: Optional[str] = Cookie(None),
):
    current_user, redirect = await require_admin(request, db, access_token)
    if redirect:
        return redirect

    # Count total visitors
    result = await db.execute(sa.select(func.count(Visitor.id)))
    total_visitors = result.scalar()
    

    # Pagination
    # offset = (page - 1) * per_page
    query = await db.execute(
        # sa.select(Visitor).order_by(Visitor.check_in_time.desc()).offset(offset).limit(per_page)
          sa.select(Visitor).order_by(Visitor.check_in_time.desc())

    )
    visitors = query.scalars().all()

    # total_pages = (total_visitors + per_page - 1) // per_page

    return admin_templates.TemplateResponse(
        "visitor.html",
        {
            "request": request,
            "current_user": current_user,
            "all_visitors": visitors,
            # "page": page,
            # "total_pages": total_pages,
            # "per_page": per_page,
            "current_date": datetime.utcnow().strftime("%A, %B %d, %Y"),
            "current_time": datetime.utcnow().strftime("%H:%M:%S"),
        },
    )









#===============================================RECEPTIONIST DASHBOARD ==============================================================


@app.get("/receptionist/dashboard", response_class=HTMLResponse)
async def receptionist_dashboard(
    request: Request,
    db: AsyncSession = Depends(get_db),
    access_token: Optional[str] = Cookie(None)
):
    # Receptionist auth
    current_user, redirect = await require_receptionist(request, db, access_token)
    if redirect:
        return redirect

    # Today's visitors (custom CRUD)
    today_visitors = await crud.count_today_visitors(db)

    # Recent visitors (latest 10)
    recent_visitors = await crud.get_recent_visitors(db, limit=10)


    # Count total visitors
    result = await db.execute(sa.select(func.count(Visitor.id)))
    total_visitors = result.scalar()

    # ---------------- Future visitors --------------------------
    current_day = datetime.now().date()  # today’s date only

    query_future = await db.execute(
        sa.select(Visitor)
        .where(func.date(Visitor.check_in_time) > current_day)   # ✅ only future visitors
        .order_by(Visitor.check_in_time.asc())                   # nearest upcoming first
    )
    future_visitors = query_future.scalars().all()

    # ✅ get count
    apointment_visitors = len(future_visitors)

    print("Future visitors count:", apointment_visitors)


    # ---------------- Masked recent visitors --------------------------
    masked_visitors = []
    for v in recent_visitors:
        masked_visitors.append({
           "id": v.id,
            "name": mask_name(v.name),
            "email": mask_email(v.email),
            "phone": mask_phone(v.phone),
            "company": v.company,
            "host": v.host,
            "address": mask_address(v.address),
            "check_in_time": v.check_in_time,
        })



    # ---------------- Render template --------------------------
    return reception_templates.TemplateResponse(
        "index.html",
        {
            "request": request,
            "current_user": current_user,
            "today_visitors": today_visitors,        # visitors checked-in today
            "total_visitors": total_visitors,        # total visitor count (int)
            "apointment_visitors": apointment_visitors,  # future visitors count (int)
            "recent_visitors": masked_visitors,      # recent masked visitors
        }
    )




# ========================================== RECEPTIONIST VISITOR ENDPOINTS ===============================================


@app.get("/receptionist/visitors/all", response_class=HTMLResponse)
async def receptionist_all_visitors(
    request: Request,
    db: AsyncSession = Depends(get_db),
    access_token: Optional[str] = Cookie(None),
):
    # Receptionist auth check
    current_user, redirect = await require_receptionist(request, db, access_token)
    if redirect:
        return redirect

    # Count total visitors
    result = await db.execute(sa.select(func.count(Visitor.id)))
    total_visitors = result.scalar()

    # Fetch all past + current visitors (newest first)
    query = await db.execute(
        sa.select(Visitor)
        .order_by(Visitor.check_in_time.desc())
    )
    visitors = query.scalars().all()

    # ---------------- Future visitors --------------------------
    current_day = datetime.now().date()   # today's date

    query_future = await db.execute(
        sa.select(Visitor)
        .where(func.date(Visitor.check_in_time) > current_day)   # ✅ only future
        .order_by(Visitor.check_in_time.asc())                   # nearest upcoming first
    )
    future_visitors = query_future.scalars().all()
    print(visitors)
    print("====",future_visitors)


    # ---------------- Masked past/current visitors ----------------
    visitors_data = []

    if visitors:
        for visitor in visitors:

            if visitor.check_in_time:
                check_in_time_formatted = visitor.check_in_time.strftime("%d %b %Y, %I:%M %p")
                visitors_data.append({
                    "id": visitor.id,
                    "masked_name": mask_name(visitor.name),
                    "initials": get_initials(visitor.name),
                    "company": visitor.company,
                    "masked_email": mask_email(visitor.email),
                    "masked_phone": mask_phone(visitor.phone),
                    "host": visitor.host,
                    "masked_address": mask_address(visitor.address),
                    "check_in_time": check_in_time_formatted,
                    "check_in_time_raw": visitor.check_in_time.isoformat(),
                })

    # ---------------- Masked future visitors ----------------
    future_visitors_data = []

    if future_visitors is not None:
        for visitor in future_visitors:

            if visitor.check_in_time:
                only_date = visitor.check_in_time.strftime("%d %b %Y")  # only date
                future_visitors_data.append({
                    "id": visitor.id,
                    "masked_name": mask_name(visitor.name),
                    "initials": get_initials(visitor.name),
                    "company": visitor.company,
                    "masked_email": mask_email(visitor.email),
                    "masked_phone": mask_phone(visitor.phone),
                    "host": visitor.host,
                    "masked_address": mask_address(visitor.address),
                    "check_in_time": only_date,
                    "check_in_time_raw": visitor.check_in_time.isoformat(),
                })

    # ---------------- Date/time + messages ----------------
    current_time = datetime.now()
    current_date_display = current_time.strftime("%A, %B %d, %Y")
    current_time_display = current_time.strftime("%H:%M:%S")
    flashed_messages = get_flashed_messages(request, with_categories=True)

    apointment_visitors = len(future_visitors)

    return reception_templates.TemplateResponse(
        "visitor.html",
        {
            "request": request,
            "current_user": current_user,
            "all_visitors": visitors_data,
            "total_visitors": total_visitors,
            "future_visitors": future_visitors_data,   # ✅ safe now
            "apointment_visitors":apointment_visitors,
            "current_date": current_date_display,
            "current_time": current_time_display,
            "flashed_messages": flashed_messages,
        },
    )






@app.post("/receptionist/visitors/check-in", response_class=HTMLResponse)
async def receptionist_check_in_submit(
    request: Request,
    name: str = Form(...),
    company: str = Form(None),
    email: str = Form(None),
    phone: str = Form(...),
    otp: str = Form(...),
    date: str = Form(...),
    time: str = Form(...),
    host: str = Form(...),
    # purpose: str = Form(...),
    address: str = Form(None),
    db: AsyncSession = Depends(get_db),
    access_token: Optional[str] = Cookie(None),
):
    # ✅ Receptionist auth check
    current_user, redirect = await require_receptionist(request, db, access_token)
    if redirect:
        return redirect

    # ✅ OTP Required Check
    if not otp or otp.strip() == "":
        flash(request, "OTP is required before check-in!", "danger")
        return RedirectResponse(url="/receptionist/visitors/all", status_code=303)
    try:
        otp_int = int(otp)
    except ValueError:
        flash(request, "OTP must be a number!", "danger")
        return RedirectResponse(url="/receptionist/visitors/all", status_code=303)

    otp_record = await db.execute(
        select(OTP)
        .join(Visitor)
        .where(Visitor.phone == (phone), OTP.otp_code == str(otp_int))   # ✅ int compare
    )

    otp_row = otp_record.scalar_one_or_none()

    if not otp_row:
        flash(request, "Invalid OTP! Please try again.", "danger")
        return RedirectResponse(url="/receptionist/visitors/all", status_code=303)

    # ✅ Parse date and time
    if date.strip() and time.strip():
        try:
            check_in_time = datetime.strptime(f"{date} {time}", "%Y-%m-%d %H:%M")
        except ValueError:
            check_in_time = datetime.now(IST)
    else:
        check_in_time = datetime.now(IST)

    check_in_time = check_in_time.replace(tzinfo=None)

    print("came to store")

    # ✅ Create new visitor only if OTP is valid


    # new_visitor = await db.execute(
    #     select(Visitor)
    #     .join(Visitor)
    #     .where(Visitor.phone == (phone))   # ✅ int compare
    # )
    get_visitor = await db.execute(select(Visitor).where(Visitor.phone == phone))
    new_visitor = get_visitor.scalars().first()

    print("viairot is",new_visitor,type(new_visitor))


    if not new_visitor:
        flash(request, "Please verify your otp first", "danger")
        return RedirectResponse(url="/receptionist/visitors/all", status_code=303)



    new_visitor.name=name
    new_visitor.company=company
    new_visitor.email=email
    new_visitor.host=host
    # purpose=purpose,
    new_visitor.address=address
    new_visitor.check_in_time=check_in_time
    new_visitor.created_by=current_user["id"]


    db.add(new_visitor)
    await db.commit()
    await db.refresh(new_visitor)

    print("visitor stored")
    # ✅ Success
    flash(request, f"Visitor {name} checked in successfully!", "success")
    return RedirectResponse(url="/receptionist/visitors/all", status_code=303)
# ----------------------------------  SMS OTP ----------------------------------------

# @app.post("/sms/send")
# async def send_sms(payload: SMSRequest, settings: Settings = Depends(get_settings)):
#     return await _send_to_gateway(payload, settings)



@app.post("/sms/send")
async def send_sms(
    payload: SMSRequest,
    db: AsyncSession = Depends(get_db),
    settings:Settings = Depends(get_settings)
):
    

    print("payload is",payload)
    # ✅ Find visitor either by visitor_id OR fallback to phone
    if payload.visitor_id:
        result = await db.execute(
            sa.select(Visitor).where(Visitor.id == payload.visitor_id)
        )
        visitor_obj = result.scalar_one_or_none()
    else:

        # create a new visitor

        visitor_obj = Visitor(
           phone=payload.mobile
        )
        db.add(visitor_obj)
        await db.commit()
        await db.refresh(visitor_obj)

        # result = await db.execute(
        #     sa.select(Visitor)
        #     .where(Visitor.phone == payload.mobile)
        #     .order_by(Visitor.check_in_time.desc())  # latest record
        #     .limit(1)
        # )
        # visitor_obj = result.scalar_one_or_none()
    # print("visitor object is",visitor_obj)

    if not visitor_obj:
        raise HTTPException(status_code=404, detail="Visitor not found")

    # ✅ Generate and save OTP
    otp = await generate_and_store_otp(db, visitor_obj)

    # ✅ Construct SMS text (append OTP if required)
    sms_text = f"{payload.msg}. Your OTP is {otp}"

    print(payload,type(payload))

    # ✅ Send SMS via gateway (your utility)
    # gateway_payload = {
    #     "mobile": payload.mobile,
    #     "msg": sms_text,
    #     "senderid": payload.senderid if payload.senderid else "ODHGRP",
    #     "msgType": payload.msgType,
    #     "sendMethod": payload.sendMethod,
    # }

    await _send_to_gateway(payload, settings, db, visitor_obj)

    return {"ok": True, "message": "OTP sent successfully"}




# @app.post("/receptionist/visitors/verify-otp")
# async def verify_visitor_otp(
#     phone: int = Form(...),
#     otp: str = Form(...),
#     db: AsyncSession = Depends(get_db),
# ):
  

#     res=verify_and_delete_otp(db,phone, otp)

#     print("is otp verified",otp,res)
#     if res:
#         return {"ok": True, "message": "OTP verified successfully"}
#     return JSONResponse(content={"ok": False, "message": "OTP verification failed"})



@app.post("/receptionist/visitors/verify-otp")
async def verify_visitor_otp(phone: str = Form(...), otp: str = Form(...), db: AsyncSession = Depends(get_db)):
    # yahan DB ya cache se OTP check karo
    otp_record = await db.execute(
        select(OTP)
        .join(Visitor)
        .where(Visitor.phone == phone, OTP.otp_code == str(otp))
    )
    otp_row = otp_record.scalar_one_or_none()

    if otp_row:
        return {"ok": True, "message": "OTP verified successfully"}
    else:
        return {"ok": False, "message": "Invalid OTP"}







@app.get("/logout")
async def logout():
    response = RedirectResponse(url="/", status_code=status.HTTP_302_FOUND)
    response.delete_cookie("access_token")
    return response







    <!--  ---------------------------  admin base ----------------------------- -->


    <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Receptionist Panel{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c3e50',
                        secondary: '#3498db',
                        accent: '#e74c3c',
                        light: '#ecf0f1',
                        dark: '#2c3e50',
                        success: '#2ecc71',
                        warning: '#f39c12',
                        info: '#17a2b8',
                    }
                }
            }
        }
    </script>
    <style>
        .status {
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status.waiting {
            background-color: #ffe6cc;
            color: #ff9933;
        }

        .status.checked-in {
            background-color: #e6f7ee;
            color: #00b33c;
        }

        .status.checked-out {
            background-color: #e6e6e6;
            color: #666;
        }

        /* Custom styles for sidebar */
        .sidebar {
            transition: all 0.3s ease;
        }

        @media (max-width: 1023px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 40;
                /* height: 100vh; */
                top: 0;
                left: 0;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 30;
            }

            .overlay.active {
                display: block;
            }
        }

        /* Modal styles */
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: scale(0.9);
            opacity: 0;
        }

        .modal.active {
            transform: scale(1);
            opacity: 1;
        }

        /* Animation for notifications */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body class="bg-[#f5f7fa] min-h-screen flex flex-col" style="margin-bottom: 55px;">
    <!-- Header -->
    <!-- <header class="bg-gradient-to-r from-primary to-secondary text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button id="menu-toggle" class="lg:hidden text-white focus:outline-none">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-concierge-bell text-2xl"></i>
                    <h1 class="text-xl font-semibold">Receptionist Dashboard</h1>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center text-white font-bold">
                        {{ user_initials|default('RS') }}</div>
                    <div class="hidden sm:block">{{ username|default('Rita Sharma') }} <span
                            class="status checked-in">Online</span></div>
                </div>
            </div>
        </div>
    </header> -->


    <header class="bg-gradient-to-r from-primary to-secondary text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button id="menu-toggle" class="lg:hidden text-white focus:outline-none">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-concierge-bell text-2xl"></i>
                    <h1 class="text-xl font-semibold">Reception Admin Panel</h1>
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <!-- Initials circle -->
                    <div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center text-white font-bold">
                        {{ current_user.username[0]|upper }}{{ current_user.username.split(' ')[1][0]|upper if
                        current_user.username.split(' ')|length > 1 else '' }}
                    </div>
                    <div class="hidden sm:block">
                        {{ current_user.username }}
                        <span class="status checked-in">Online</span>
                    </div>



                </div>
            </div>
        </div>
    </header>





    <!-- Overlay for mobile sidebar -->
    <div id="overlay" class="overlay"></div>

    <div class="flex flex-1">
        <!-- Sidebar -->
        <aside id="sidebar"
            class="sidebar bg-white w-64 p-4 shadow-sm h-full fixed lg:sticky lg:top-20 lg:translate-x-0 z-40"
            style="height: 81vh;">
            <div class="flex justify-between items-center mb-6 lg:hidden">
                <h2 class="text-lg font-semibold text-dark">Menu</h2>
                <button id="close-menu" class="text-dark hover:text-secondary">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <ul class="space-y-2" style="height: 400px;">
                <!-- Dashboard -->
                <li>
                    <a href="/admin/dashboard"
                        class="flex items-center p-3 rounded-lg 
               {% if request.url.path == '/admin/dashboard' %}bg-secondary text-white{% else %}text-dark hover:bg-secondary hover:text-white{% endif %}">
                        <i class="fas fa-home w-5 text-center mr-2"></i> Dashboard
                    </a>
                </li>

                <!-- Visitors (Current) -->
                <li>
                    <a href="/admin/visitors/all"
                        class="flex items-center p-3 rounded-lg 
               {% if request.url.path.startswith('/admin/visitors/all') %}bg-secondary text-white{% else %}text-dark hover:bg-secondary hover:text-white{% endif %}">
                        <i class="fas fa-users w-5 text-center mr-2"></i> Visitors
                    </a>
                </li>
                <!-- User Details -->

                <li>
                    <a href="/admin/users"
                        class="flex items-center p-3 rounded-lg 
       {% if request.url.path == '/admin/users' %}bg-secondary text-white{% else %}text-dark hover:bg-secondary hover:text-white{% endif %}">
                        <i class="fas fa-user-cog w-5 text-center mr-2"></i> User Management
                    </a>
                </li>

                <!-- Logout -->
                <li class="pt-4 border-t border-gray-200">
                    <a href="/logout"
                        class="flex items-center p-3 rounded-lg text-dark hover:bg-secondary hover:text-white">
                        <i class="fas fa-sign-out-alt w-5 text-center mr-2"></i> Logout
                    </a>
                </li>
            </ul>
        </aside>


        <!-- Main Content -->
        <main class="flex-1 p-4 lg:ml-0">
            <div class="container mx-auto">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center p-4 fixed bottom-0 left-0 w-full">
        <p>© 2025 Receptionist Panel | Designed for ODH Corporation</p>
    </footer>

    <!-- Check In Modal -->
    <!-- <div id="check-in-modal"
        class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-dark">Check In Visitor</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5">
                <form id="check-in-form" action="/receptionist/visitors/check-in" method="post">
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="visitor-name">Full Name</label>
                        <input type="text" id="visitor-name" name="visitor_name"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary"
                            required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="company">Company</label>
                        <input type="text" id="company" name="company"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary"
                            required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="email">Email</label>
                        <input type="email" id="email" name="email"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="phone">Phone</label>
                        <input type="tel" id="phone" name="phone"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="meeting-with">Meeting With</label>
                        <select id="meeting-with" name="meeting_with"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary"
                            required>
                            <option value="">Select an employee</option>
                            <option value="Mr. Agarwal">Mr. Agarwal</option>
                            <option value="Ms. Desai">Ms. Desai</option>
                            <option value="Mr. Joshi">Mr. Joshi</option>
                            <option value="Mr. Kumar">Mr. Kumar</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2" for="purpose">Purpose of Visit</label>
                        <textarea id="purpose" name="purpose" rows="3"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-check-in"
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">Cancel</button>
                        <button type="submit"
                            class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-blue-600">Check In</button>
                    </div>
                </form>
            </div>
        </div>
    </div> -->



    <script>
        // Toggle mobile menu
        document.getElementById('menu-toggle').addEventListener('click', function () {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('overlay').classList.add('active');
        });

        document.getElementById('close-menu').addEventListener('click', function () {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        });

        document.getElementById('overlay').addEventListener('click', function () {
            document.getElementById('sidebar').classList.remove('active');
            this.classList.remove('active');
        });

        // Check-in modal functionality
        document.getElementById('check-in-btn').addEventListener('click', function () {
            document.getElementById('check-in-modal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('check-in-modal').classList.add('active');
            }, 10);
        });

        document.getElementById('close-modal').addEventListener('click', closeModal);
        document.getElementById('cancel-check-in').addEventListener('click', closeModal);

        function closeModal() {
            document.getElementById('check-in-modal').classList.remove('active');
            setTimeout(() => {
                document.getElementById('check-in-modal').classList.add('hidden');
            }, 300);
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US');
        }

        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Handle form submission
        document.getElementById('check-in-form').addEventListener('submit', function (e) {
            e.preventDefault();
            // You would typically send this data to your backend
            alert('Visitor checked in successfully!');
            closeModal();
            this.reset();
        });
    </script>




    {% block extra_js %}{% endblock %}
</body>

</html>




















{% extends "base.html" %}

{% block title %}Visitors Management - Receptionist Panel{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8">

  <!-- Header + DateTime -->
  <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
    <h2 class="text-xl sm:text-2xl font-semibold text-dark">Welcome, {{ current_user.username }}!</h2>
    <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
      <div class="bg-white p-3 rounded-lg shadow-sm flex flex-wrap items-center justify-between w-full lg:w-auto">
        <div class="flex items-center text-sm sm:text-base">
          <i class="fas fa-calendar text-secondary mr-2"></i>
          <span id="current-date">{{ current_date }}</span>
        </div>
        <span class="hidden sm:inline mx-2">|</span>
        <div class="flex items-center text-sm sm:text-base mt-2 sm:mt-0">
          <i class="fas fa-clock text-secondary mr-2"></i>
          <span id="current-time">{{ current_time }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Flash Messages -->
  {% if flashed_messages %}
  <div id="flash-container" class="mb-4 space-y-2">
    {% for category, message in flashed_messages %}
    <div class="flash-message p-3 rounded-lg shadow
      {% if category == 'success' %} bg-green-100 border border-green-400 text-green-800
      {% elif category == 'danger' or category == 'error' %} bg-red-100 border border-red-400 text-red-800
      {% elif category == 'warning' %} bg-yellow-100 border border-yellow-400 text-yellow-800
      {% else %} bg-blue-100 border border-blue-400 text-blue-800
      {% endif %}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Tabs -->
  <!-- Tabs -->
  <div class="flex flex-wrap justify-center sm:justify-start gap-3 pb-3 border-b border-gray-200 mb-4">

    <!-- All Visitors -->
    <button class="tab px-6 py-2 text-sm sm:text-base font-semibold text-white 
    bg-gradient-to-r from-purple-600/60 via-pink-600/60 to-red-600/60 
    backdrop-blur-xl border border-white/30 
    rounded-2xl shadow-lg 
    hover:from-purple-500/80 hover:via-pink-500/80 hover:to-red-500/80 
    hover:border-white/50 hover:shadow-2xl hover:scale-105 
    transition-all duration-300 ease-in-out text-center flex-1 sm:flex-none" data-tab="all">
      All Visitors
    </button>

    <!-- Scheduled Appointment -->
    <button class="tab px-6 py-2 text-sm sm:text-base font-semibold text-white 
    bg-gradient-to-r from-pink-600/60 via-orange-600/60 to-yellow-600/60 
    backdrop-blur-xl border border-white/30 
    rounded-2xl shadow-lg 
    hover:from-pink-500/80 hover:via-orange-500/80 hover:to-yellow-500/80 
    hover:border-white/50 hover:shadow-2xl hover:scale-105 
    transition-all duration-300 ease-in-out text-center flex-1 sm:flex-none" data-tab="scheduled">
      Scheduled Appointment
    </button>

    <!-- Check-In -->
    <button class="tab px-6 py-2 text-sm sm:text-base font-semibold text-white 
    bg-gradient-to-r from-indigo-600/60 via-sky-600/60 to-cyan-600/60 
    backdrop-blur-xl border border-white/30 
    rounded-2xl shadow-lg 
    hover:from-indigo-500/80 hover:via-sky-500/80 hover:to-cyan-500/80 
    hover:border-white/50 hover:shadow-2xl hover:scale-105 
    transition-all duration-300 ease-in-out text-center flex-1 sm:flex-none" data-tab="checkin">
      Check-In
    </button>

  </div>






<!-- ✅ All Visitors Tab -->
<div class="tab-content grid grid-cols-1 lg:grid-cols-2 gap-5 mb-6" id="all-tab">
  <div class="bg-white p-5 rounded-xl shadow-sm lg:col-span-2">
    <!-- Header -->
    <div class="flex justify-between items-center pb-3 border-b border-gray-200 mb-4">
      <h3 class="text-lg font-semibold text-dark">All Visitors</h3>
      <a href="/receptionist/visitors/all" class="text-secondary hover:underline"></a>
    </div>

    <!-- Table Wrapper -->
    <div class="overflow-x-auto bg-white rounded-xl shadow-sm hide-scrollbar">
      <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      </style>

      <table class="w-full table-fixed text-sm text-left border-collapse min-w-[900px]">
        <thead class="bg-gradient-to-r from-pink-500 via-orange-500 to-yellow-500 text-white sticky top-0 z-10">
          <tr>
            <th class="w-1/6 py-3 px-4 rounded-tl-lg">Name</th>
            <th class="w-1/6 py-3 px-4">Phone</th>
            <th class="w-1/6 py-3 px-4">To Meet</th>
            <th class="w-1/6 py-3 px-4">Purpose</th>
            <th class="w-1/6 py-3 px-4">City</th>
            <th class="w-1/6 py-3 px-4">State</th>
            <th class="w-1/6 py-3 px-4 rounded-tr-lg">Action</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for visitor in all_visitors %}
          <tr class="hover:bg-gray-50 transition">
            <td class="py-3 px-4 font-medium text-dark whitespace-nowrap">{{ visitor.masked_name }}</td>
            <td class="py-3 px-4 text-gray-600 whitespace-nowrap">{{ visitor.masked_phone }}</td>
            <td class="py-3 px-4 text-gray-600 whitespace-nowrap">{{ visitor.host }}</td>
            <td class="py-3 px-4 text-gray-600 whitespace-nowrap">{{ visitor.purpose }}</td>
            <td class="py-3 px-4 text-gray-600 whitespace-nowrap">{{ visitor.city }}</td>
            <td class="py-3 px-4 text-gray-600 whitespace-nowrap">{{ visitor.state }}</td>
            <td class="py-3 px-4 flex items-center gap-2">
              {% if visitor.check_out_time %}
              <span class="text-green-600 font-medium">Checked Out</span>
              {% else %}
              <span class="text-yellow-600 font-medium">Check-In</span>
              <button
                class="checkout-btn inline-flex items-center px-2 py-1 ml-2 rounded-full bg-green-500 text-white hover:bg-green-600 transition"
                data-visitor-id="{{ visitor.id }}">
                <!-- Lucide Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                  stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
              </button>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="7" class="py-4 px-4 text-center text-gray-500 italic">No visitors found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex flex-col sm:flex-row justify-center items-center mt-6 gap-3 sm:gap-6">
      <button id="prev-btn-all" class="px-5 py-2 rounded-2xl bg-gradient-to-r from-violet-600 to-purple-500 text-white font-semibold shadow-xl backdrop-blur-md bg-opacity-80 
             hover:scale-105 hover:shadow-2xl hover:from-violet-700 hover:to-purple-600 transition-all duration-300 ease-in-out disabled:opacity-40 disabled:cursor-not-allowed">
        ⬅ Prev
      </button>

      <span id="page-info-all" class="px-4 py-2 rounded-xl text-sm sm:text-base font-bold text-violet-800 bg-white/30 shadow-lg backdrop-blur-md border border-violet-200 animate-pulse">
        Page 1 of 5
      </span>

      <button id="next-btn-all" class="px-5 py-2 rounded-2xl bg-gradient-to-r from-purple-500 to-violet-600 text-white font-semibold shadow-xl backdrop-blur-md bg-opacity-80 
             hover:scale-105 hover:shadow-2xl hover:from-purple-600 hover:to-violet-700 transition-all duration-300 ease-in-out disabled:opacity-40 disabled:cursor-not-allowed">
        Next ➡
      </button>
    </div>
  </div>
</div>


  <!------------------------Scheduled Apointment------------------------------>

  <!-- ✅ Scheduled Appointment Tab -->
  <div class="tab-content grid grid-cols-1 lg:grid-cols-2 gap-5 mb-6 hidden" id="scheduled-tab">
    <div class="bg-white p-5 rounded-xl shadow-sm lg:col-span-2">
      <!-- Header -->
      <div class="flex justify-between items-center pb-3 border-b border-gray-200 mb-4">
        <h3 class="text-lg font-semibold text-dark">Scheduled Appointment</h3>
        <a href="/receptionist/visitors/all" class="text-secondary hover:underline"></a>
      </div>

      <!-- Table Wrapper -->
      <div class="overflow-x-auto overflow-y-auto bg-white rounded-xl shadow-sm custom-scrollbar">
        <table id="scheduled-table" class="w-full min-w-[950px] text-sm text-left border-collapse">
          <thead class="bg-gradient-to-r from-pink-500 via-orange-500 to-yellow-500 text-white sticky top-0 z-10">
            <tr>
              <th class="py-3 px-4 rounded-tl-lg">Name</th>
              <th class="py-3 px-4">Phone</th>
              <th class="py-3 px-4">To Meet</th>
              <th class="py-3 px-4">Purpose</th>
              <th class="py-3 px-4">City</th>
              <th class="py-3 px-4">State</th>
              <th class="py-3 px-4 rounded-tr-lg">Scheduled Time</th>
            </tr>

          <tbody class="divide-y divide-gray-200">
            {% for visitor in future_visitors %}
            <tr class="hover:bg-gray-50 transition">
              <td class="py-3 px-4">
                <div class="font-medium text-dark">{{ visitor.masked_name }}</div>
              </td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.masked_phone }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.host }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.purpose }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.city }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.state }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.check_in_time }}</td>

            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="py-4 px-4 text-center text-gray-500 italic">
                No scheduled appointments found
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex justify-center items-center mt-6 space-x-6">

        <!-- Prev Button -->
        <button id="prev-btn-scheduled" class="px-5 py-2 rounded-2xl bg-gradient-to-r from-violet-600 to-purple-500 text-white font-semibold shadow-xl backdrop-blur-md bg-opacity-80 
           hover:scale-105 hover:shadow-2xl hover:from-violet-700 hover:to-purple-600 transition-all duration-300 ease-in-out 
           disabled:opacity-40 disabled:cursor-not-allowed">
          ⬅ Prev
        </button>

        <!-- Page Info Badge -->
        <span id="page-info-scheduled" class="px-4 py-2 rounded-xl text-sm font-bold text-violet-800 bg-white/30 shadow-lg backdrop-blur-md border border-violet-200 
           animate-pulse">
          Page 1 of 5
        </span>

        <!-- Next Button -->
        <button id="next-btn-scheduled" class="px-5 py-2 rounded-2xl bg-gradient-to-r from-purple-500 to-violet-600 text-white font-semibold shadow-xl backdrop-blur-md bg-opacity-80 
           hover:scale-105 hover:shadow-2xl hover:from-purple-600 hover:to-violet-700 transition-all duration-300 ease-in-out 
           disabled:opacity-40 disabled:cursor-not-allowed">
          Next ➡
        </button>

      </div>



      <!-- <div class="pagination">
        <button id="prev-btn-scheduled" type="button">Prev</button>
        <span id="page-info-scheduled"></span>
        <div id="page-numbers-scheduled" class="inline-flex"></div>
        <button id="next-btn-scheduled" type="button">Next</button>
      </div> -->

    </div>
  </div>


  <!-- ✅ Check-In Tab -->
  <!-- ✅ Check-In Tab -->
  <div class="tab-content hidden" id="checkin-tab">
    <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">Visitor Check-In</h2>

    <!-- OTP Flash Messages -->
    <div id="otp-flash-message" class="mb-3"></div>

    <form id="checkin-form" method="post" action="/receptionist/visitors/check-in"
      class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- Phone + OTP -->
      <div class="flex flex-col">
        <label for="checkin-phone" class="mb-1 font-medium">Phone Number *</label>
        <div class="flex gap-2">
          <input type="tel" id="checkin-phone" name="phone" required
            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
          <button type="button" id="send-otp-btn"
            class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
            Send OTP
          </button>
        </div>
      </div>

      <!-- OTP Input -->
      <div id="otp-box" class="hidden flex flex-col">
        <label for="checkin-otp" class="mb-1 font-medium">Enter OTP *</label>
        <input type="text" id="checkin-otp" name="otp" placeholder="Enter received OTP"
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>

      <!-- Name -->
      <div class="flex flex-col">
        <label for="checkin-name" class="mb-1 font-medium">Full Name *</label>
        <input type="text" id="checkin-name" name="name" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>

      <!-- State Dropdown with Search -->
      <div class="flex flex-col">
        <label for="checkin-state" class="mb-1 font-medium">State *</label>
        <input type="text" id="state-search" placeholder="Search State..."
          class="p-2 border border-gray-300 rounded-lg mb-2 focus:ring-2 focus:ring-indigo-500">
        <select id="checkin-state" name="state" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
      </div>

      <!-- City Dropdown with Search -->
      <div class="flex flex-col">
        <label for="checkin-city" class="mb-1 font-medium">City *</label>
        <input type="text" id="city-search" placeholder="Search City..."
          class="p-2 border border-gray-300 rounded-lg mb-2 focus:ring-2 focus:ring-indigo-500">
        <select id="checkin-city" name="city" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
      </div>

      <!-- Check-In Date -->
      <div class="flex flex-col">
        <label for="checkin-date" class="mb-1 font-medium">Check-In Date *</label>
        <input type="date" id="checkin-date" name="date" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>

      <!-- Check-In Time -->
      <div class="flex flex-col">
        <label for="checkin-time" class="mb-1 font-medium">Check-In Time *</label>
        <input type="time" id="checkin-time" name="time" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>

      <!-- Purpose -->
      <div class="flex flex-col">
        <label for="checkin-purpose" class="mb-1 font-medium">Purpose *</label>
        <select id="checkin-purpose" name="purpose" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
          <option value="">Select purpose</option>
          <option value="meeting">Business Meeting</option>
          <option value="interview">Job Interview</option>
          <option value="delivery">Delivery</option>
          <option value="other">Other</option>
        </select>
      </div>

      <!-- Address -->
      <div class="flex flex-col md:col-span-2">
        <label for="checkin-address" class="mb-1 font-medium">Address</label>
        <textarea id="checkin-address" name="address" rows="3"
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
      </div>

      <!-- Submit -->
      <div class="flex justify-end gap-3 md:col-span-2">
        <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          Check-In Visitor
        </button>
      </div>
    </form>
  </div>

</div>

<!-- ✅ Scripts -->

<script>
  // ----------- CHECK-OUT FEATURE -----------
  document.querySelectorAll(".checkout-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const visitorId = btn.dataset.visitorId;

      // API call to mark visitor as checked out
      const response = await fetch(`/receptionist/visitors/checkout/${visitorId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      if (response.ok) {
        const data = await response.json();
        // Update row UI
        const row = btn.closest("tr");
        row.querySelector("td:nth-child(8)").textContent = data.check_out_time; // Check-Out time
        btn.outerHTML = `<span class="text-green-600 font-medium">Checked Out</span>`;
      } else {
        alert("Failed to check-out visitor!");
      }
    });
  });


  // ----------- STATE & CITY DROPDOWNS -----------

  // Fetch states (India)
  async function fetchStates() {
    const res = await fetch("https://countriesnow.space/api/v0.1/countries/states", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ country: "India" })
    });
    const data = await res.json();
    const states = data.data.states.map(s => s.name).sort();

    const stateSelect = document.getElementById("state-select");
    states.forEach(st => {
      let option = document.createElement("option");
      option.value = st;
      option.textContent = st;
      stateSelect.appendChild(option);
    });
  }

  // Fetch cities of selected state
  async function fetchCities(stateName) {
    const res = await fetch("https://countriesnow.space/api/v0.1/countries/state/cities", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ country: "India", state: stateName })
    });
    const data = await res.json();
    const cities = data.data.sort();

    const citySelect = document.getElementById("city-select");
    citySelect.innerHTML = "";
    cities.forEach(ct => {
      let option = document.createElement("option");
      option.value = ct;
      option.textContent = ct;
      citySelect.appendChild(option);
    });
  }

  // Search filter for State & City
  function setupSearch(inputId, selectId) {
    const input = document.getElementById(inputId);
    const select = document.getElementById(selectId);

    input.addEventListener("input", () => {
      const search = input.value.toLowerCase();
      Array.from(select.options).forEach(opt => {
        opt.style.display = opt.textContent.toLowerCase().includes(search) ? "" : "none";
      });
    });
  }

  // Init
  fetchStates();
  setupSearch("state-search", "state-select");
  setupSearch("city-search", "city-select");

  document.getElementById("state-select").addEventListener("change", e => {
    fetchCities(e.target.value);
  });
</script>



<script>

  // validation regex
  const phoneRegex = /^\d{10}$/;
  const otpRegex = /^\d{6}$/;




  // small helper to show temporary messages in the OTP flash area
  function showOtpFlashMessage(html, ttl = 7000) {
    const container = document.getElementById('otp-flash-message');
    if (!container) return;
    container.innerHTML = html;
    if (ttl > 0) setTimeout(() => {
      if (container) container.innerHTML = '';
    }, ttl);
  }

  // sanitize typing: allow only digits and limit length
  document.getElementById('checkin-phone').addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
  });
  document.getElementById('checkin-otp').addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
  });




  let otpTimer;

  // OTP send
  document.getElementById("send-otp-btn").addEventListener("click", async () => {
    const phone = document.getElementById("checkin-phone").value;
    if (!phone) {
      alert("Please enter phone number first!");
      return;
    }

    let res = await fetch("/sms/send", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mobile: phone,
        msg: "Your OTP for Visitor Check-In",
        senderid: "ODHGRP",
      })
    });

    if (res.ok) {
      document.getElementById("otp-box").style.display = "flex";
      alert("OTP sent successfully to visitor's phone.");
      startOtpCountdown();
    } else {
      alert("Failed to send OTP!");
    }
  });

  // ✅ Countdown function
  function startOtpCountdown() {
    const btn = document.getElementById("send-otp-btn");
    let timeLeft = 60;

    btn.disabled = true;
    btn.textContent = `Resend OTP in ${timeLeft}s`;

    otpTimer = setInterval(() => {
      timeLeft--;
      btn.textContent = `Resend OTP in ${timeLeft}s`;

      if (timeLeft <= 0) {
        clearInterval(otpTimer);
        btn.disabled = false;
        btn.textContent = "Resend OTP";
      }
    }, 1000);
  }




  // document.addEventListener('DOMContentLoaded', function () {
  //   // Initialize date/time fields
  //   // const now = new Date();
  //   // document.getElementById('checkin-date').value = now.toISOString().slice(0, 10);
  //   // document.getElementById('checkin-time').value = now.toTimeString().slice(0, 5);

  //   // Tabs
  //   function switchTab(tabName) {
  //     document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
  //     document.getElementById(tabName + '-tab').classList.remove('hidden');
  //     document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
  //     document.querySelector('.tab[data-tab="' + tabName + '"]').classList.add('border-secondary', 'text-secondary');
  //   }
  //   document.querySelectorAll('.tab').forEach(tab => {
  //     tab.addEventListener('click', () => switchTab(tab.getAttribute('data-tab')));
  //   });


  //   // Pagination
  //   const rowsPerPage = 8;
  //   let currentPage = 1;
  //   const visitor_table = document.getElementById("visitors-table");
  //   const scheduled_table = document.getElementById("scheduled-table");
  //   const rows = table.querySelectorAll("tbody tr");
  //   const totalPages = Math.ceil(rows.length / rowsPerPage);
  //   function renderTable() {
  //     rows.forEach((row, i) => {
  //       row.style.display = (i >= (currentPage - 1) * rowsPerPage && i < currentPage * rowsPerPage) ? "" : "none";
  //     });
  //     document.getElementById("page-info").textContent = `Page ${currentPage} of ${totalPages}`;
  //     document.getElementById("prev-btn").disabled = currentPage === 1;
  //     document.getElementById("next-btn").disabled = currentPage === totalPages;
  //   }
  //   document.getElementById("prev-btn").addEventListener("click", () => {
  //     if (currentPage > 1) { currentPage--; renderTable(); }
  //   });
  //   document.getElementById("next-btn").addEventListener("click", () => {
  //     if (currentPage < totalPages) { currentPage++; renderTable(); }
  //   });

  //   // Header Date/Time update
  //   function updateDateTime() {
  //     const now = new Date();
  //     document.getElementById('current-date').textContent =
  //       now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  //     document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US');
  //   }
  //   updateDateTime();
  //   setInterval(updateDateTime, 1000);



  //   // Default: open All tab
  //   switchTab('all');
  //   renderTable();
  // });







  // ✅ Auto-hide flash

  document.addEventListener('DOMContentLoaded', function () {
    // Tabs
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.getElementById(tabName + '-tab').classList.remove('hidden');
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
      document.querySelector('.tab[data-tab="' + tabName + '"]').classList.add('border-secondary', 'text-secondary');
    }
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.getAttribute('data-tab')));
    });

    // 🔹 Generic Pagination Function with Page Numbers
    function setupPagination(tableId, prevBtnId, nextBtnId, pageInfoId, pageNumbersId, rowsPerPage = 8) {
      let currentPage = 1;
      const table = document.getElementById(tableId);
      const rows = table.querySelectorAll("tbody tr");

      function renderTable() {
        const totalPages = Math.ceil(rows.length / rowsPerPage);

        // Show only required rows
        rows.forEach((row, i) => {
          row.style.display = (i >= (currentPage - 1) * rowsPerPage && i < currentPage * rowsPerPage) ? "" : "none";
        });

        // Update page info
        document.getElementById(pageInfoId).textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById(prevBtnId).disabled = currentPage === 1;
        document.getElementById(nextBtnId).disabled = currentPage === totalPages;

        // Render page number buttons
        const pageNumbersContainer = document.getElementById(pageNumbersId);
        pageNumbersContainer.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.className = "px-2 py-1 border rounded mx-1 " + (i === currentPage ? "bg-secondary text-white" : "bg-gray-100");
          btn.addEventListener("click", () => {
            currentPage = i;
            renderTable();
          });
          pageNumbersContainer.appendChild(btn);
        }
      }

      // Prev/Next buttons
      document.getElementById(prevBtnId).addEventListener("click", () => {
        if (currentPage > 1) { currentPage--; renderTable(); }
      });
      document.getElementById(nextBtnId).addEventListener("click", () => {
        const totalPages = Math.ceil(rows.length / rowsPerPage);
        if (currentPage < totalPages) { currentPage++; renderTable(); }
      });

      renderTable(); // ✅ Initial render
    }

    // 🔹 Apply Pagination to Both Tables
    setupPagination("visitors-table", "prev-btn-all", "next-btn-all", "page-info-all", "page-numbers-all");
    setupPagination("scheduled-table", "prev-btn-scheduled", "next-btn-scheduled", "page-info-scheduled", "page-numbers-scheduled");

    // Header Date/Time update
    function updateDateTime() {
      const now = new Date();
      document.getElementById('current-date').textContent =
        now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US');
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // Default: open All tab
    switchTab('all');
  });





  setTimeout(() => {
    document.querySelectorAll(".flash-message").forEach(el => el.remove());
  }, 8000);

  // ✅ OTP Verify before final submit

  // OTP Verify before final submit (form submit handler)
  document.getElementById("checkin-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);
    const phone = (formData.get("phone") || '').trim();
    const otp = (formData.get("otp") || '').trim();

    // Validate phone locally
    if (!phoneRegex.test(phone)) {
      showOtpFlashMessage(
        `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
           Phone must be exactly 10 digits.
         </div>`
      );
      document.getElementById("checkin-phone").focus();
      activateCheckinTab();
      return;
    }

    // Validate OTP locally
    if (!otpRegex.test(otp)) {
      showOtpFlashMessage(
        `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
           OTP is required for check-in .
         </div>`
      );
      document.getElementById("otp-box").style.display = "flex";
      document.getElementById("checkin-otp").focus();
      activateCheckinTab();
      return;
    }

    // If local checks pass, call server to verify OTP
    try {
      const verifyResponse = await fetch("/receptionist/visitors/verify-otp", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ phone: phone, otp: otp })
      });
      const verifyResult = await verifyResponse.json();

      if (verifyResult.ok) {
        // OTP success — proceed with normal form submit
        form.submit();
      } else {
        showOtpFlashMessage(
          `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
            ${verifyResult.message || 'Incorrect OTP.'}
          </div>`
        );
        activateCheckinTab();
        document.getElementById("checkin-otp").focus();
      }
    } catch (err) {
      showOtpFlashMessage(
        `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
           Error verifying OTP. Please try again.
         </div>`
      );
      activateCheckinTab();
    }
  });

  function activateCheckinTab() {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById('checkin-tab').classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
    document.querySelector('.tab[data-tab="checkin"]').classList.add('border-secondary', 'text-secondary');
  }
</script>

<script>
  let timeInterval;

  function fillDateTime(live = false) {
    const now = new Date();

    // ✅ current date set (YYYY-MM-DD)
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    document.getElementById('checkin-date').value = `${year}-${month}-${day}`;

    // ✅ current time set (HH:MM)
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('checkin-time').value = `${hours}:${minutes}`;

    if (live) {
      clearInterval(timeInterval);
      timeInterval = setInterval(() => {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('checkin-time').value = `${hours}:${minutes}`;
      }, 1000);
    }
  }

  function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
    document.querySelector('.tab[data-tab="' + tabName + '"]').classList.add('border-secondary', 'text-secondary');

    if (tabName === "checkin") {
      fillDateTime(true);
    } else {
      clearInterval(timeInterval);
    }
  }

  function activateCheckinTab() {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById('checkin-tab').classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
    document.querySelector('.tab[data-tab="checkin"]').classList.add('border-secondary', 'text-secondary');

    fillDateTime(true);
  }

  document.addEventListener("DOMContentLoaded", () => {
    fillDateTime();
  });
</script>

{% endblock %}











<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Receptionist Panel{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2c3e50',
            secondary: '#3498db',
            accent: '#e74c3c',
            light: '#ecf0f1',
            dark: '#2c3e50',
            success: '#2ecc71',
            warning: '#f39c12',
            info: '#17a2b8',
          }
        }
      }
    }
  </script>

  <style>
    .status {
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status.waiting {
      background-color: #ffe6cc;
      color: #ff9933;
    }

    .status.checked-in {
      background-color: #e6f7ee;
      color: #00b33c;
    }

    .status.checked-out {
      background-color: #e6e6e6;
      color: #666;
    }

    /* Sidebar animation */
    .sidebar {
      transition: transform 0.2s ease-in-out;
    }

    @media (max-width: 1023px) {
      .sidebar {
        transform: translateX(-100%);
        position: fixed;
        z-index: 40;
        height: 100vh;
        top: 0;
        left: 0;
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 30;
      }

      .overlay.active {
        display: block;
      }
    }

    /* Modal animation */
    .modal {
      transition: opacity 0.2s ease, transform 0.2s ease;
      transform: scale(0.9);
      opacity: 0;
    }

    .modal.active {
      transform: scale(1);
      opacity: 1;
    }

    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #c5c5c5;
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }




/* ------------------- Toast Animations ------------------- */

    @keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

.toast {
  animation: slideIn 0.3s ease forwards;
}

.toast.hide {
  animation: slideOut 0.3s ease forwards;
}

  </style>
  {% block extra_css %}{% endblock %}
</head>

<body class="bg-[#f5f7fa] min-h-screen flex flex-col" style="margin-bottom: 55px;">

  <!-- Header -->
  <!-- <header class="bg-gradient-to-r from-primary to-secondary text-white p-4 shadow-md sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <button id="menu-toggle" class="lg:hidden text-white focus:outline-none">
          <i class="fas fa-bars text-xl"></i>
        </button>
        <div class="flex items-center space-x-2">
          <i class="fas fa-concierge-bell text-2xl"></i>
          <h1 class="text-xl font-semibold">Receptionist Dashboard</h1>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
          <div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center text-white font-bold">
            {{ current_user.username[0]|upper }}{{ current_user.username.split(' ')[1][0]|upper if current_user.username.split(' ')|length > 1 else '' }}
          </div>
          <div class="hidden sm:block">
            {{ current_user.username }}
            <span class="status checked-in">Online</span>
          </div>
        </div>
      </div>
    </div>
  </header> -->


<header class="bg-gradient-to-r from-primary to-secondary text-white p-4 shadow-md sticky top-0 z-50">
  <div class="container mx-auto flex justify-between items-center">
    <!-- Left: Menu + Title -->
    <div class="flex items-center space-x-4">
      <button id="menu-toggle" class="lg:hidden text-white focus:outline-none">
        <i class="fas fa-bars text-xl"></i>
      </button>
      <div class="flex items-center space-x-2">
        <i class="fas fa-concierge-bell text-2xl"></i>
        <h1 class="text-xl font-semibold">Receptionist Dashboard</h1>
      </div>
    </div>

    <!-- Right: User + Notification -->
    <div class="flex items-center space-x-4">
      <!-- Notification Bell -->
      <div class="relative mr-4">
        <i id="notification-bell" class="fas fa-bell text-xl cursor-pointer relative">
          <span id="notification-dot" class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full hidden"></span>
        </i>
      </div>



      

      <!-- User Info -->
      <div class="flex items-center space-x-2">
        <div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center text-white font-bold">
          {{ current_user.username[0]|upper }}{{ current_user.username.split(' ')[1][0]|upper if current_user.username.split(' ')|length > 1 else '' }}
        </div>
        <div class="hidden sm:block">
          {{ current_user.username }}
          <span class="status checked-in">Online</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast-container" class="fixed top-16 right-5 flex flex-col space-y-2 z-50"></div>
</header>



  <!-- Overlay -->
  <div id="overlay" class="overlay"></div>

  <div class="flex flex-1">
    <!-- Sidebar -->
    <aside id="sidebar"
      class="sidebar bg-white w-64 p-4 shadow-sm fixed lg:sticky lg:top-20 lg:translate-x-0 z-40 h-screen lg:h-[81vh] overflow-y-auto custom-scrollbar">
      <div class="flex justify-between items-center mb-6 lg:hidden">
        <h2 class="text-lg font-semibold text-dark">Menu</h2>
        <button id="close-menu" class="text-dark hover:text-secondary">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <ul class="space-y-2">
        <li>
          <a href="/receptionist/dashboard"
            class="flex items-center p-3 rounded-lg {% if request.url.path == '/receptionist/dashboard' %}bg-secondary text-white{% else %}text-dark hover:bg-secondary hover:text-white{% endif %}">
            <i class="fas fa-home w-5 text-center mr-2"></i> Dashboard
          </a>
        </li>

        <li>
          <a href="/receptionist/visitors/all"
            class="flex items-center p-3 rounded-lg {% if request.url.path.startswith('/receptionist/visitors') %}bg-secondary text-white{% else %}text-dark hover:bg-secondary hover:text-white{% endif %}">
            <i class="fas fa-users w-5 text-center mr-2"></i> Visitors
          </a>
        </li>
        

        
        <li class="pt-4 border-t border-gray-200">
          <a href="/logout" class="flex items-center p-3 rounded-lg text-dark hover:bg-secondary hover:text-white">
            <i class="fas fa-sign-out-alt w-5 text-center mr-2"></i> Logout
          </a>
        </li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4 lg:ml-0">
      <div class="container mx-auto">
        {% block content %}
        
        {% endblock %}
      </div>
    </main>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white text-center p-4 fixed bottom-0 left-0 w-full">
    <p>© 2025 Receptionist Panel | Designed for ODH Corporation</p>
  </footer>

  <script>
    // Sidebar toggle
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');

    document.getElementById('menu-toggle').addEventListener('click', () => {
      sidebar.classList.add('active');
      overlay.classList.add('active');
    });

    document.getElementById('close-menu').addEventListener('click', () => {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
    });

    overlay.addEventListener('click', () => {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
    });

    // Modal (optional - only if exists in content)
    const checkInBtn = document.getElementById('check-in-btn');
    if (checkInBtn) {
      checkInBtn.addEventListener('click', () => {
        const modal = document.getElementById('check-in-modal');
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.add('active'), 10);
      });
    }

    function closeModal() {
      const modal = document.getElementById('check-in-modal');
      modal.classList.remove('active');
      setTimeout(() => modal.classList.add('hidden'), 200);
    }

    const closeModalBtn = document.getElementById('close-modal');
    const cancelCheckIn = document.getElementById('cancel-check-in');

    if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
    if (cancelCheckIn) cancelCheckIn.addEventListener('click', closeModal);

    // Date & Time updater
    function updateDateTime() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const dateEl = document.getElementById('current-date');
      const timeEl = document.getElementById('current-time');
      if (dateEl) dateEl.textContent = now.toLocaleDateString('en-US', options);
      if (timeEl) timeEl.textContent = now.toLocaleTimeString('en-US');
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);
  </script>

<script>
  const ws = new WebSocket(`ws://${window.location.host}/ws/receptionist`);

  const bell = document.getElementById("notification-bell");
  const dot = document.getElementById("notification-dot");
  const toastContainer = document.getElementById("toast-container");

  ws.onmessage = (event) => {
      const msg = event.data;

      // Show red dot on bell
      dot.classList.remove("hidden");

      // Create toast
      const toast = document.createElement("div");
      toast.className = "toast bg-blue-500 min-w-[220px] px-4 py-2 rounded shadow-lg text-white font-medium animate-slideIn";
      toast.textContent = msg;

      toastContainer.prepend(toast);

      // Auto-hide after 5s
      setTimeout(() => {
          toast.classList.add("hide");
          setTimeout(() => toast.remove(), 300);
      }, 5000);
  };

  // Clicking bell clears red dot
  bell.addEventListener("click", () => {
      dot.classList.add("hidden");
  });
</script>

<script>
  // Connect to WebSocket
  const ws = new WebSocket("ws://127.0.0.1:8000/ws/receptionist");

  ws.onmessage = (event) => {
      alert(event.data);  // Popup notification for receptionist
  };

  // Early Meeting Button
  document.querySelectorAll(".early-meeting-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
          const visitorId = btn.dataset.visitorId;
          try {
              const response = await fetch(`/admin/notify-early-meeting/${visitorId}`, {
                  method: "POST",
                  headers: {"Content-Type": "application/json"}
              });
              const result = await response.json();
              if (response.ok) {
                  alert("Receptionist notified about early meeting!");
              } else {
                  alert(result.detail || "Failed to notify receptionist.");
              }
          } catch (error) {
              console.error("Error:", error);
              alert("Error sending notification.");
          }
      });
  });
</script>




  {% block extra_js %}
  
  {% endblock %}
</body>

</html>
