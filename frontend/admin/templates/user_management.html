{% extends "base.html" %}

{% block title %}User Management - Admin Panel{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-dark">User Management</h2>
        <button id="add-user-btn"
            class="bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 
                   hover:from-purple-600 hover:via-pink-600 hover:to-red-600
                   text-white px-4 py-2 rounded-lg flex items-center">
            <i class="fas fa-plus mr-2"></i> Add User
        </button>
    </div>

    <!-- Success/Error Messages -->
    {% if success %}
    <div id="flash-message" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        {{ success }}
    </div>
    {% endif %}

    {% if error %}
    <div id="flash-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        {{ error }}
    </div>
    {% endif %}

    <!-- Users Table -->
    <div class="overflow-x-auto">
        <table class="w-full table-auto">
            <thead>
                <tr class="bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 text-white text-left">
                    <th class="p-3">ID</th>
                    <th class="p-3">Username</th>
                    <th class="p-3">Role</th>
                    <th class="p-3 text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr class="border-b border-gray-200 hover:bg-gradient-to-r hover:from-purple-50 hover:via-pink-50 hover:to-red-50">
                    <td class="p-3">{{ user.id }}</td>
                    <td class="p-3 font-medium">{{ user.username }}</td>
                    <td class="p-3">
                        <span
                            class="px-2 py-1 rounded-full text-xs font-semibold {% if user.role == 'admin' %}bg-purple-200 text-purple-800{% else %}bg-pink-200 text-pink-800{% endif %}">
                            {{ user.role }}
                        </span>
                    </td>
                    <td class="p-3 text-center">
                        <button class="edit-user-btn text-purple-600 hover:text-pink-600 mr-2" data-id="{{ user.id }}"
                            data-username="{{ user.username }}" data-role="{{ user.role }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-user-btn text-red-600 hover:text-red-700" data-id="{{ user.id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages is defined and total_pages > 1 %}
    <div class="flex justify-center mt-6">
        <div class="flex space-x-2">
            {% if page > 1 %}
            <a href="?page={{ page - 1 }}"
                class="px-3 py-2 border border-gray-300 rounded-lg text-dark hover:bg-gray-100">
                <i class="fas fa-chevron-left"></i>
            </a>
            {% endif %}

            {% for p in range(1, total_pages + 1) %}
            <a href="?page={{ p }}"
                class="px-3 py-2 border border-gray-300 rounded-lg {% if p == page %}bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 text-white{% else %}text-dark hover:bg-gray-100{% endif %}">
                {{ p }}
            </a>
            {% endfor %}

            {% if page < total_pages %}
            <a href="?page={{ page + 1 }}"
                class="px-3 py-2 border border-gray-300 rounded-lg text-dark hover:bg-gray-100">
                <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Add User Modal -->
<div id="add-user-modal"
    class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md">
        <div class="p-5 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-dark">Add New User</h3>
            <button class="close-modal text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-5">
            <form id="add-user-form" action="/admin/users/" method="post">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="username">Username</label>
                    <input type="text" id="username" name="username"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="password">Password</label>
                    <input type="password" id="password" name="password"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="role">Role</label>
                    <select id="role" name="role"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                        <option value="">Select Role</option>
                        <option value="admin">Admin</option>
                        <option value="receptionist">Receptionist</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button"
                        class="close-modal px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 text-white rounded-lg hover:from-purple-600 hover:via-pink-600 hover:to-red-600">
                        Add User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div id="edit-user-modal"
    class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md">
        <div class="p-5 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-dark">Edit User</h3>
            <button class="close-modal text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-5">
            <form id="edit-user-form" method="put">
                <input type="hidden" id="edit-user-id" name="user_id">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="edit-username">Username</label>
                    <input type="text" id="edit-username" name="username"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="edit-password">Password (leave blank to keep current)</label>
                    <input type="password" id="edit-password" name="password"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2" for="edit-role">Role</label>
                    <select id="edit-role" name="role"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                        <option value="admin">Admin</option>
                        <option value="receptionist">Receptionist</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button"
                        class="close-modal px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 text-white rounded-lg hover:from-purple-600 hover:via-pink-600 hover:to-red-600">
                        Update User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-user-modal"
    class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md">
        <div class="p-5 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-dark">Confirm Deletion</h3>
            <button class="close-modal text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-5">
            <p class="mb-4">Are you sure you want to delete this user? This action cannot be undone.</p>
            <form id="delete-user-form" method="delete">
                <input type="hidden" id="delete-user-id" name="user_id">
                <div class="flex justify-end space-x-3">
                    <button type="button"
                        class="close-modal px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-gradient-to-r from-red-500 via-pink-500 to-purple-500 text-white rounded-lg hover:from-red-600 hover:via-pink-600 hover:to-purple-600">
                        Delete User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Modal functionality
    function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
        setTimeout(() => { document.getElementById(modalId).classList.add('active'); }, 10);
    }
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        setTimeout(() => { document.getElementById(modalId).classList.add('hidden'); }, 300);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Add user
        document.getElementById('add-user-btn').addEventListener('click', () => openModal('add-user-modal'));

        // Edit user buttons
        document.querySelectorAll('.edit-user-btn').forEach(button => {
            button.addEventListener('click', function () {
                const userId = this.getAttribute('data-id');
                const username = this.getAttribute('data-username');
                const role = this.getAttribute('data-role');

                document.getElementById('edit-user-id').value = userId;
                document.getElementById('edit-username').value = username;
                document.getElementById('edit-role').value = role;

                openModal('edit-user-modal');
            });
        });

        // Delete user buttons
        document.querySelectorAll('.delete-user-btn').forEach(button => {
            button.addEventListener('click', function () {
                const userId = this.getAttribute('data-id');
                document.getElementById('delete-user-id').value = userId;
                openModal('delete-user-modal');
            });
        });

        // Close modal buttons
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', function () {
                const modal = this.closest('.modal');
                closeModal(modal.id);
            });
        });

        // Close modal when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
        });

        // Flash message reload
        function triggerFlashReload() {
            const flash = document.getElementById('flash-message');
            if (flash) {
                setTimeout(() => {
                    flash.style.transition = "opacity 0.5s ease";
                    flash.style.opacity = "0";
                    setTimeout(() => { window.location.reload(); }, 600);
                }, 5000);
            }
        }
        triggerFlashReload();

        // Edit form
        document.getElementById('edit-user-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const userId = document.getElementById('edit-user-id').value;
            try {
                const response = await fetch(`/admin/users/manage/${userId}`, {
                    method: 'PUT',
                    body: formData
                });
                if (response.redirected) { window.location.href = response.url; }
                else { document.body.innerHTML = await response.text(); triggerFlashReload(); }
            } catch (error) { console.error('Error:', error); }
        });

        // Delete form
        document.getElementById('delete-user-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const userId = document.getElementById('delete-user-id').value;
            try {
                const response = await fetch(`/admin/users/${userId}`, { method: 'DELETE' });
                if (response.redirected) { window.location.href = response.url; }
                else { document.body.innerHTML = await response.text(); triggerFlashReload(); }
            } catch (error) { console.error('Error:', error); }
        });
    });
</script>
{% endblock %}
{% endblock %}
