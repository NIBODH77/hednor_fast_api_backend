{% extends "base.html" %}

{% block title %}Visitors Management - Receptionist Panel{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8">

  <!-- Header + DateTime -->
  <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
    <h2 class="text-xl sm:text-2xl font-semibold text-dark">Welcome, {{ current_user.username }}!</h2>
    <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
      <div class="bg-white p-3 rounded-lg shadow-sm flex flex-wrap items-center justify-between w-full lg:w-auto">
        <div class="flex items-center text-sm sm:text-base">
          <i class="fas fa-calendar text-secondary mr-2"></i>
          <span id="current-date">{{ current_date }}</span>
        </div>
        <span class="hidden sm:inline mx-2">|</span>
        <div class="flex items-center text-sm sm:text-base mt-2 sm:mt-0">
          <i class="fas fa-clock text-secondary mr-2"></i>
          <span id="current-time">{{ current_time }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… Flash Messages -->
  {% if flashed_messages %}
  <div id="flash-container" class="mb-4 space-y-2">
    {% for category, message in flashed_messages %}
    <div class="flash-message p-3 rounded-lg shadow
      {% if category == 'success' %} bg-green-100 border border-green-400 text-green-800
      {% elif category == 'danger' or category == 'error' %} bg-red-100 border border-red-400 text-red-800
      {% elif category == 'warning' %} bg-yellow-100 border border-yellow-400 text-yellow-800
      {% else %} bg-blue-100 border border-blue-400 text-blue-800
      {% endif %}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Tabs -->
  <!-- Tabs -->
  <div class="flex flex-wrap justify-center sm:justify-start gap-3 pb-3 border-b border-gray-200 mb-4">

    <!-- All Visitors -->
    <button class="tab px-6 py-2 text-sm sm:text-base font-semibold text-white 
    bg-gradient-to-r from-purple-600/60 via-pink-600/60 to-red-600/60 
    backdrop-blur-xl border border-white/30 
    rounded-2xl shadow-lg 
    hover:from-purple-500/80 hover:via-pink-500/80 hover:to-red-500/80 
    hover:border-white/50 hover:shadow-2xl hover:scale-105 
    transition-all duration-300 ease-in-out text-center flex-1 sm:flex-none" data-tab="all">
      All Visitors
    </button>

    <!-- Scheduled Appointment -->
    <button class="tab px-6 py-2 text-sm sm:text-base font-semibold text-white 
    bg-gradient-to-r from-pink-600/60 via-orange-600/60 to-yellow-600/60 
    backdrop-blur-xl border border-white/30 
    rounded-2xl shadow-lg 
    hover:from-pink-500/80 hover:via-orange-500/80 hover:to-yellow-500/80 
    hover:border-white/50 hover:shadow-2xl hover:scale-105 
    transition-all duration-300 ease-in-out text-center flex-1 sm:flex-none" data-tab="scheduled">
      Scheduled Appointment
    </button>

    <!-- Check-In -->
    <button class="tab px-6 py-2 text-sm sm:text-base font-semibold text-white 
    bg-gradient-to-r from-indigo-600/60 via-sky-600/60 to-cyan-600/60 
    backdrop-blur-xl border border-white/30 
    rounded-2xl shadow-lg 
    hover:from-indigo-500/80 hover:via-sky-500/80 hover:to-cyan-500/80 
    hover:border-white/50 hover:shadow-2xl hover:scale-105 
    transition-all duration-300 ease-in-out text-center flex-1 sm:flex-none" data-tab="checkin">
      Check-In/Book Apointment
    </button>

  </div>






  <!-- âœ… All Visitors Tab -->
  <div class="tab-content grid grid-cols-1 lg:grid-cols-2 gap-5 mb-6" id="all-tab">
    <div class="bg-white p-5 rounded-xl shadow-sm lg:col-span-2">
      <!-- Header -->
      <div class="flex justify-between items-center pb-3 border-b border-gray-200 mb-4">
        <h3 class="text-lg font-semibold text-dark">All Visitors</h3>
        <a href="/receptionist/visitors/all" class="text-secondary hover:underline"></a>
      </div>

      <!-- Table Wrapper -->
      <div class="overflow-x-auto bg-white rounded-xl shadow-sm hide-scrollbar">
        <style>
          .hide-scrollbar::-webkit-scrollbar {
            display: none;
          }

          .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
          }
        </style>

        <table class="w-full table-auto text-sm text-left border-collapse min-w-[900px]">
          <thead class="bg-gradient-to-r from-pink-500 via-orange-500 to-yellow-500 text-white sticky top-0 z-10">
            <tr>
              <th class="w-1/6 py-3 px-4 rounded-tl-lg">Name</th>
              <th class="w-1/6 py-3 px-4">Phone</th>
              <th class="w-1/6 py-3 px-4">To Meet</th>
              <th class="w-1/6 py-3 px-4">Purpose</th>
              <th class="w-1/6 py-3 px-4">City</th>
              <th class="w-1/6 py-3 px-4">State</th>
              <th class="w-1/6 py-3 px-4">Check-In</th>
              <th class="w-1/6 py-3 px-4">Check-Out</th>

              <th class="w-1/6 py-3 px-4 rounded-tr-lg">Action</th>
            </tr>
          </thead>
          <tbody id="all-visitors-body" class="divide-y divide-gray-200">
            {% for visitor in all_visitors %}
            <tr class="hover:bg-gray-50 transition">
              <td class="py-3 px-4 font-medium text-dark whitespace-nowrap">{{ visitor.masked_name }}</td>
              <td class="py-3 px-4 text-gray-600 whitespace-nowrap">{{ visitor.masked_phone }}</td>
              <td class="py-3 px-4 text-gray-600 whitespace-nowrap">{{ visitor.host }}</td>
              <td class="py-3 px-4 text-gray-600 whitespace-nowrap">{{ visitor.purpose }}</td>
              <td class="py-3 px-4 text-gray-600 whitespace-nowrap">{{ visitor.city }}</td>
              <td class="py-3 px-4 text-gray-600 whitespace-nowrap">{{ visitor.state }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.check_in_time }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.check_out_time }}</td>


              <td class="py-3 px-4 flex items-center gap-2">
                {% if visitor.check_out_time %}
                <span class="text-green-600 font-medium">Checked Out</span>
                {% else %}
                <span class="text-yellow-600 font-medium">Check-In</span>
                <button
                  class="checkout-btn inline-flex items-center px-2 py-1 ml-2 rounded-full bg-green-500 text-white hover:bg-green-600 transition"
                  data-visitor-id="{{ visitor.id }}">
                  <!-- Lucide Icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M14 5l7 7m0 0l-7 7m7-7H3" />
                  </svg>
                </button>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="7" class="py-4 px-4 text-center text-gray-500 italic">No visitors found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex flex-col sm:flex-row justify-center items-center mt-6 gap-3 sm:gap-6">
        <button id="prev-btn-all"
          class="px-5 py-2 rounded-2xl bg-gradient-to-r from-violet-600 to-purple-500 text-white font-semibold shadow-xl backdrop-blur-md bg-opacity-80 
             hover:scale-105 hover:shadow-2xl hover:from-violet-700 hover:to-purple-600 transition-all duration-300 ease-in-out disabled:opacity-40 disabled:cursor-not-allowed">
          â¬… Prev
        </button>

        <span id="page-info-all"
          class="px-4 py-2 rounded-xl text-sm sm:text-base font-bold text-violet-800 bg-white/30 shadow-lg backdrop-blur-md border border-violet-200 animate-pulse">
          Page 1 of 5
        </span>

        <button id="next-btn-all"
          class="px-5 py-2 rounded-2xl bg-gradient-to-r from-purple-500 to-violet-600 text-white font-semibold shadow-xl backdrop-blur-md bg-opacity-80 
             hover:scale-105 hover:shadow-2xl hover:from-purple-600 hover:to-violet-700 transition-all duration-300 ease-in-out disabled:opacity-40 disabled:cursor-not-allowed">
          Next âž¡
        </button>
      </div>
    </div>
  </div>


  <!------------------------Scheduled Apointment------------------------------>

  <!-- âœ… Scheduled Appointment Tab -->
  <!-- âœ… Scheduled Appointment Tab -->
  <!-- âœ… Scheduled Appointment Tab -->
  <div class="tab-content grid grid-cols-1 lg:grid-cols-2 gap-5 mb-6 hidden" id="scheduled-tab">
    <div class="bg-white p-5 rounded-xl shadow-sm lg:col-span-2">
      <!-- Header -->
      <div class="flex justify-between items-center pb-3 border-b border-gray-200 mb-4">
        <h3 class="text-lg font-semibold text-dark">Scheduled Appointments</h3>
        <a href="/receptionist/visitors/all" class="text-secondary hover:underline">View All</a>
      </div>

      <!-- Table Wrapper -->
      <div class="overflow-x-auto overflow-y-auto bg-white rounded-xl shadow-sm custom-scrollbar">
        <table id="scheduled-table" class="w-full min-w-[1000px] text-sm text-left border-collapse">
          <thead class="bg-gradient-to-r from-pink-500 via-orange-500 to-yellow-500 text-white sticky top-0 z-10">
            <tr>
              <th class="py-3 px-4 rounded-tl-lg">Name</th>
              <th class="py-3 px-4">Phone</th>
              <th class="py-3 px-4">To Meet</th>
              <th class="py-3 px-4">Purpose</th>
              <th class="py-3 px-4">City</th>
              <th class="py-3 px-4">State</th>
              <th class="py-3 px-4">Scheduled Time</th>
              <th class="py-3 px-4 rounded-tr-lg">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {% for visitor in future_visitors %}
            <tr class="hover:bg-gray-50 transition">
              <td class="py-3 px-4 font-medium text-dark">{{ visitor.masked_name }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.masked_phone }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.host }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.purpose }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.city }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.state }}</td>
              <td class="py-3 px-4 text-gray-600">{{ visitor.check_in_time }}</td>
              <td class="py-3 px-4">
                <a href="/receptionist/visitors/edit/{{ visitor.id }}"
                  class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                  Edit
                </a>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="py-4 px-4 text-center text-gray-500 italic">
                No scheduled appointments found
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="flex justify-center items-center mt-6 space-x-6">
        <button id="prev-btn-scheduled" class="px-5 py-2 rounded-2xl bg-gradient-to-r from-violet-600 to-purple-500 text-white font-semibold shadow-xl backdrop-blur-md bg-opacity-80 
               hover:scale-105 hover:shadow-2xl hover:from-violet-700 hover:to-purple-600 transition-all duration-300 ease-in-out 
               disabled:opacity-40 disabled:cursor-not-allowed">
          â¬… Prev
        </button>

        <span id="page-info-scheduled"
          class="px-4 py-2 rounded-xl text-sm font-bold text-violet-800 bg-white/30 shadow-lg backdrop-blur-md border border-violet-200 animate-pulse">
          Page 1 of 5
        </span>

        <button id="next-btn-scheduled" class="px-5 py-2 rounded-2xl bg-gradient-to-r from-purple-500 to-violet-600 text-white font-semibold shadow-xl backdrop-blur-md bg-opacity-80 
               hover:scale-105 hover:shadow-2xl hover:from-purple-600 hover:to-violet-700 transition-all duration-300 ease-in-out 
               disabled:opacity-40 disabled:cursor-not-allowed">
          Next âž¡
        </button>
      </div>
    </div>
  </div>



  <!-- âœ… Check-In Tab -->
  <div class="tab-content hidden" id="checkin-tab">
    <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">Visitor Check-In</h2>

    <!-- OTP Flash Messages -->
    <div id="otp-flash-message" class="mb-3"></div>

    <form id="checkin-form" method="post" action="/receptionist/visitors/check-in"
      class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- Phone + OTP -->
      <div class="flex flex-col">
        <label for="checkin-phone" class="mb-1 font-medium">Phone Number *</label>
        <div class="flex gap-2">
          <input type="tel" id="checkin-phone" name="phone" required
            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
          <button type="button" id="send-otp-btn"
            class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
            Send OTP
          </button>
        </div>
      </div>

      <!-- OTP Input -->
      <div id="otp-box" class="hidden flex flex-col">
        <label for="checkin-otp" class="mb-1 font-medium">Enter OTP *</label>
        <input type="text" id="checkin-otp" name="otp" placeholder="Enter received OTP"
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>

      <!-- Name -->
      <div class="flex flex-col">
        <label for="checkin-name" class="mb-1 font-medium">Full Name *</label>
        <input type="text" id="checkin-name" name="name" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>

      <!-- âœ… To Meet -->
      <div class="flex flex-col">
        <label for="checkin-to-meet" class="mb-1 font-medium">To Meet *</label>
        <input type="text" id="checkin-to-meet" name="host" placeholder="Whom visitor wants to meet" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>

      <!-- Purpose -->
      <div class="flex flex-col">
        <label for="checkin-purpose" class="mb-1 font-medium">Purpose *</label>
        <select id="checkin-purpose" name="purpose" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
          <option value="">Select purpose</option>
          <option value="meeting">Business Meeting</option>
          <option value="interview">Job Interview</option>
          <option value="delivery">Delivery</option>
          <option value="other">Other</option>
        </select>
      </div>

      <!-- State Dropdown with Search -->
      <div class="flex flex-col">
        <label for="checkin-state" class="mb-1 font-medium">State *</label>
        <input type="text" id="state-search" placeholder="Search State..."
          class="p-2 border border-gray-300 rounded-lg mb-2 focus:ring-2 focus:ring-indigo-500">
        <select id="checkin-state" name="state" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
      </div>

      <!-- City Dropdown with Search -->
      <div class="flex flex-col">
        <label for="checkin-city" class="mb-1 font-medium">City *</label>
        <input type="text" id="city-search" placeholder="Search City..."
          class="p-2 border border-gray-300 rounded-lg mb-2 focus:ring-2 focus:ring-indigo-500">
        <select id="checkin-city" name="city" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></select>
      </div>


      <!-- Check-In Date -->
      <div class="flex flex-col">
        <label for="checkin-date" class="mb-1 font-medium">Check-In Date *</label>
        <input type="date" id="checkin-date" name="date" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>

      <!-- Check-In Time -->
      <div class="flex flex-col">
        <label for="checkin-time" class="mb-1 font-medium">Check-In Time *</label>
        <input type="time" id="checkin-time" name="time" required
          class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>

      <!-- Submit -->
      <div class="flex justify-end gap-3 md:col-span-2">
        <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          Check-In Visitor
        </button>
      </div>
    </form>
  </div>



</div>

<!-- âœ… Scripts -->




<script>
  // ----------- CHECK-OUT FEATURE -----------
  document.querySelectorAll(".checkout-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const visitorId = btn.dataset.visitorId;

      const response = await fetch(`/checkout/${visitorId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      if (response.ok) {
        const data = await response.json();
        const row = btn.closest("tr");

        // âœ… Update Check-Out column (8th column)
        const checkoutCell = row.querySelector("td:nth-child(8)");
        checkoutCell.textContent = data.check_out_time;

        // âœ… Replace Action column (9th column) with "Checked Out"
        const actionCell = row.querySelector("td:nth-child(9)");
        actionCell.innerHTML = `<span class="text-green-600 font-medium">Checked Out</span>`;
      } else {
        alert("Failed to check-out visitor!");
      }
    });
  });



  // ----------- STATE & CITY DROPDOWNS -----------
  async function fetchStates() {
    const res = await fetch("https://countriesnow.space/api/v0.1/countries/states", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ country: "India" })
    });
    const data = await res.json();
    const states = data.data.states.map(s => s.name).sort();

    const stateSelect = document.getElementById("checkin-state");
    states.forEach(st => {
      let option = document.createElement("option");
      option.value = st;
      option.textContent = st;
      stateSelect.appendChild(option);
    });
  }

  async function fetchCities(stateName) {
    const res = await fetch("https://countriesnow.space/api/v0.1/countries/state/cities", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ country: "India", state: stateName })
    });
    const data = await res.json();
    const cities = data.data.sort();

    const citySelect = document.getElementById("checkin-city");
    citySelect.innerHTML = "";
    cities.forEach(ct => {
      let option = document.createElement("option");
      option.value = ct;
      option.textContent = ct;
      citySelect.appendChild(option);
    });
  }

  function setupSearch(inputId, selectId) {
    const input = document.getElementById(inputId);
    const select = document.getElementById(selectId);

    input.addEventListener("input", () => {
      const search = input.value.toLowerCase();
      Array.from(select.options).forEach(opt => {
        opt.style.display = opt.textContent.toLowerCase().includes(search) ? "" : "none";
      });
    });
  }

  // ----------- INIT -----------
  fetchStates();
  setupSearch("state-search", "checkin-state");
  setupSearch("city-search", "checkin-city");

  // âœ… Auto-fill selected state into search input
  document.getElementById("checkin-state").addEventListener("change", e => {
    fetchCities(e.target.value);
    document.getElementById("state-search").value = e.target.value;
  });

  // âœ… Auto-fill selected city into search input
  document.getElementById("checkin-city").addEventListener("change", e => {
    document.getElementById("city-search").value = e.target.value;
  });
</script>



<!-- <script>

  // validation regex
  const phoneRegex = /^\d{10}$/;
  const otpRegex = /^\d{6}$/;




  // small helper to show temporary messages in the OTP flash area
  function showOtpFlashMessage(html, ttl = 7000) {
    const container = document.getElementById('otp-flash-message');
    if (!container) return;
    container.innerHTML = html;
    if (ttl > 0) setTimeout(() => {
      if (container) container.innerHTML = '';
    }, ttl);
  }

  // sanitize typing: allow only digits and limit length
  document.getElementById('checkin-phone').addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
  });
  document.getElementById('checkin-otp').addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
  });




  let otpTimer;

  // OTP send
  document.getElementById("send-otp-btn").addEventListener("click", async () => {
    const phone = document.getElementById("checkin-phone").value;
    if (!phone) {
      alert("Please enter phone number first!");
      return;
    }

    let res = await fetch("/sms/send", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mobile: phone,
        msg: "Your OTP for Visitor Check-In",
        senderid: "ODHGRP",
      })
    });

    if (res.ok) {
      document.getElementById("otp-box").style.display = "flex";
      alert("OTP sent successfully to visitor's phone.");
      startOtpCountdown();
    } else {
      alert("Failed to send OTP!");
    }
  });

  // âœ… Countdown function
  function startOtpCountdown() {
    const btn = document.getElementById("send-otp-btn");
    let timeLeft = 60;

    btn.disabled = true;
    btn.textContent = `Resend OTP in ${timeLeft}s`;

    otpTimer = setInterval(() => {
      timeLeft--;
      btn.textContent = `Resend OTP in ${timeLeft}s`;

      if (timeLeft <= 0) {
        clearInterval(otpTimer);
        btn.disabled = false;
        btn.textContent = "Resend OTP";
      }
    }, 1000);
  }









  // âœ… Auto-hide flash

  document.addEventListener('DOMContentLoaded', function () {
    // Tabs
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.getElementById(tabName + '-tab').classList.remove('hidden');
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
      document.querySelector('.tab[data-tab="' + tabName + '"]').classList.add('border-secondary', 'text-secondary');
    }
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.getAttribute('data-tab')));
    });

    // ðŸ”¹ Generic Pagination Function with Page Numbers
    // function setupPagination(tableId, prevBtnId, nextBtnId, pageInfoId, pageNumbersId, rowsPerPage = 8) {
    //   let currentPage = 1;
    //   const table = document.getElementById(tableId);
    //   const rows = table.querySelectorAll("tbody tr");

    //   function renderTable() {
    //     const totalPages = Math.ceil(rows.length / rowsPerPage);

    //     // Show only required rows
    //     rows.forEach((row, i) => {
    //       row.style.display = (i >= (currentPage - 1) * rowsPerPage && i < currentPage * rowsPerPage) ? "" : "none";
    //     });

    //     // Update page info
    //     document.getElementById(pageInfoId).textContent = `Page ${currentPage} of ${totalPages}`;
    //     document.getElementById(prevBtnId).disabled = currentPage === 1;
    //     document.getElementById(nextBtnId).disabled = currentPage === totalPages;

    //     // Render page number buttons
    //     const pageNumbersContainer = document.getElementById(pageNumbersId);
    //     pageNumbersContainer.innerHTML = "";
    //     for (let i = 1; i <= totalPages; i++) {
    //       const btn = document.createElement("button");
    //       btn.textContent = i;
    //       btn.className = "px-2 py-1 border rounded mx-1 " + (i === currentPage ? "bg-secondary text-white" : "bg-gray-100");
    //       btn.addEventListener("click", () => {
    //         currentPage = i;
    //         renderTable();
    //       });
    //       pageNumbersContainer.appendChild(btn);
    //     }
    //   }

    //   // Prev/Next buttons
    //   document.getElementById(prevBtnId).addEventListener("click", () => {
    //     if (currentPage > 1) { currentPage--; renderTable(); }
    //   });
    //   document.getElementById(nextBtnId).addEventListener("click", () => {
    //     const totalPages = Math.ceil(rows.length / rowsPerPage);
    //     if (currentPage < totalPages) { currentPage++; renderTable(); }
    //   });

    //   renderTable(); // âœ… Initial render
    // }

    // // ðŸ”¹ Apply Pagination to Both Tables
    // setupPagination("visitors-table", "prev-btn-all", "next-btn-all", "page-info-all", "page-numbers-all");
    // setupPagination("scheduled-table", "prev-btn-scheduled", "next-btn-scheduled", "page-info-scheduled", "page-numbers-scheduled");

    // Header Date/Time update
    function updateDateTime() {
      const now = new Date();
      document.getElementById('current-date').textContent =
        now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US');
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // Default: open All tab
    switchTab('all');
  });





  setTimeout(() => {
    document.querySelectorAll(".flash-message").forEach(el => el.remove());
  }, 8000);




  // âœ… OTP Verify before final submit

  // OTP Verify before final submit (form submit handler)
  document.getElementById("checkin-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);
    const phone = (formData.get("phone") || '').trim();
    const otp = (formData.get("otp") || '').trim();

    // Validate phone locally
    if (!phoneRegex.test(phone)) {
      showOtpFlashMessage(
        `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
           Phone must be exactly 10 digits.
         </div>`
      );
      document.getElementById("checkin-phone").focus();
      activateCheckinTab();
      return;
    }

    // Validate OTP locally
    if (!otpRegex.test(otp)) {
      showOtpFlashMessage(
        `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
           OTP is required for check-in .
         </div>`
      );
      document.getElementById("otp-box").style.display = "flex";
      document.getElementById("checkin-otp").focus();
      activateCheckinTab();
      return;
    }

    // If local checks pass, call server to verify OTP
    try {
      const verifyResponse = await fetch("/receptionist/visitors/verify-otp", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone: phone, otp: otp })
      });
      const verifyResult = await verifyResponse.json();

      if (verifyResult.ok) {
        // OTP success â€” proceed with normal form submit
        form.submit();
      } else {
        showOtpFlashMessage(
          `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
            ${verifyResult.message || 'Incorrect OTP.'}
          </div>`
        );
        activateCheckinTab();
        document.getElementById("checkin-otp").focus();
      }
    } catch (err) {
      showOtpFlashMessage(
        `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
           Error verifying OTP. Please try again.
         </div>`
      );
      activateCheckinTab();
    }
  });

  function activateCheckinTab() {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById('checkin-tab').classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
    document.querySelector('.tab[data-tab="checkin"]').classList.add('border-secondary', 'text-secondary');
  }
</script> -->



<script>

  // validation regex
  const phoneRegex = /^\d{10}$/;
  const otpRegex = /^\d{6}$/;




  // small helper to show temporary messages in the OTP flash area
  function showOtpFlashMessage(html, ttl = 7000) {
    const container = document.getElementById('otp-flash-message');
    if (!container) return;
    container.innerHTML = html;
    if (ttl > 0) setTimeout(() => {
      if (container) container.innerHTML = '';
    }, ttl);
  }

  // sanitize typing: allow only digits and limit length
  document.getElementById('checkin-phone').addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 10);
  });
  document.getElementById('checkin-otp').addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
  });




  let otpTimer;

  // OTP send
  document.getElementById("send-otp-btn").addEventListener("click", async () => {
    const phone = document.getElementById("checkin-phone").value;
    if (!phone) {
      alert("Please enter phone number first!");
      return;
    }

    let res = await fetch("/sms/send", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mobile: phone,
        msg: "Your OTP for Visitor Check-In",
        senderid: "ODHGRP",
      })
    });

    if (res.ok) {
      document.getElementById("otp-box").style.display = "flex";
      alert("OTP sent successfully to visitor's phone.");
      startOtpCountdown();
    } else {
      alert("Failed to send OTP!");
    }
  });

  // âœ… Countdown function
  function startOtpCountdown() {
    const btn = document.getElementById("send-otp-btn");
    let timeLeft = 60;

    btn.disabled = true;
    btn.textContent = `Resend OTP in ${timeLeft}s`;

    otpTimer = setInterval(() => {
      timeLeft--;
      btn.textContent = `Resend OTP in ${timeLeft}s`;

      if (timeLeft <= 0) {
        clearInterval(otpTimer);
        btn.disabled = false;
        btn.textContent = "Resend OTP";
      }
    }, 1000);
  }




  // document.addEventListener('DOMContentLoaded', function () {
  //   // Initialize date/time fields
  //   // const now = new Date();
  //   // document.getElementById('checkin-date').value = now.toISOString().slice(0, 10);
  //   // document.getElementById('checkin-time').value = now.toTimeString().slice(0, 5);

  //   // Tabs
  //   function switchTab(tabName) {
  //     document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
  //     document.getElementById(tabName + '-tab').classList.remove('hidden');
  //     document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
  //     document.querySelector('.tab[data-tab="' + tabName + '"]').classList.add('border-secondary', 'text-secondary');
  //   }
  //   document.querySelectorAll('.tab').forEach(tab => {
  //     tab.addEventListener('click', () => switchTab(tab.getAttribute('data-tab')));
  //   });


  //   // Pagination
  //   const rowsPerPage = 8;
  //   let currentPage = 1;
  //   const visitor_table = document.getElementById("visitors-table");
  //   const scheduled_table = document.getElementById("scheduled-table");
  //   const rows = table.querySelectorAll("tbody tr");
  //   const totalPages = Math.ceil(rows.length / rowsPerPage);
  //   function renderTable() {
  //     rows.forEach((row, i) => {
  //       row.style.display = (i >= (currentPage - 1) * rowsPerPage && i < currentPage * rowsPerPage) ? "" : "none";
  //     });
  //     document.getElementById("page-info").textContent = `Page ${currentPage} of ${totalPages}`;
  //     document.getElementById("prev-btn").disabled = currentPage === 1;
  //     document.getElementById("next-btn").disabled = currentPage === totalPages;
  //   }
  //   document.getElementById("prev-btn").addEventListener("click", () => {
  //     if (currentPage > 1) { currentPage--; renderTable(); }
  //   });
  //   document.getElementById("next-btn").addEventListener("click", () => {
  //     if (currentPage < totalPages) { currentPage++; renderTable(); }
  //   });

  //   // Header Date/Time update
  //   function updateDateTime() {
  //     const now = new Date();
  //     document.getElementById('current-date').textContent =
  //       now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  //     document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US');
  //   }
  //   updateDateTime();
  //   setInterval(updateDateTime, 1000);



  //   // Default: open All tab
  //   switchTab('all');
  //   renderTable();
  // });







  // âœ… Auto-hide flash

  document.addEventListener('DOMContentLoaded', function () {
    // Tabs
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.getElementById(tabName + '-tab').classList.remove('hidden');
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
      document.querySelector('.tab[data-tab="' + tabName + '"]').classList.add('border-secondary', 'text-secondary');
    }
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.getAttribute('data-tab')));
    });

    // ðŸ”¹ Generic Pagination Function with Page Numbers
    function setupPagination(tableId, prevBtnId, nextBtnId, pageInfoId, pageNumbersId, rowsPerPage = 8) {
      let currentPage = 1;
      const table = document.getElementById(tableId);
      const rows = table.querySelectorAll("tbody tr");

      function renderTable() {
        const totalPages = Math.ceil(rows.length / rowsPerPage);

        // Show only required rows
        rows.forEach((row, i) => {
          row.style.display = (i >= (currentPage - 1) * rowsPerPage && i < currentPage * rowsPerPage) ? "" : "none";
        });

        // Update page info
        document.getElementById(pageInfoId).textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById(prevBtnId).disabled = currentPage === 1;
        document.getElementById(nextBtnId).disabled = currentPage === totalPages;

        // Render page number buttons
        const pageNumbersContainer = document.getElementById(pageNumbersId);
        pageNumbersContainer.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.className = "px-2 py-1 border rounded mx-1 " + (i === currentPage ? "bg-secondary text-white" : "bg-gray-100");
          btn.addEventListener("click", () => {
            currentPage = i;
            renderTable();
          });
          pageNumbersContainer.appendChild(btn);
        }
      }

      // Prev/Next buttons
      document.getElementById(prevBtnId).addEventListener("click", () => {
        if (currentPage > 1) { currentPage--; renderTable(); }
      });
      document.getElementById(nextBtnId).addEventListener("click", () => {
        const totalPages = Math.ceil(rows.length / rowsPerPage);
        if (currentPage < totalPages) { currentPage++; renderTable(); }
      });

      renderTable(); // âœ… Initial render
    }

    // ðŸ”¹ Apply Pagination to Both Tables
    setupPagination("visitors-table", "prev-btn-all", "next-btn-all", "page-info-all", "page-numbers-all");
    setupPagination("scheduled-table", "prev-btn-scheduled", "next-btn-scheduled", "page-info-scheduled", "page-numbers-scheduled");

    // Header Date/Time update
    function updateDateTime() {
      const now = new Date();
      document.getElementById('current-date').textContent =
        now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US');
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // Default: open All tab
    switchTab('all');
  });





  setTimeout(() => {
    document.querySelectorAll(".flash-message").forEach(el => el.remove());
  }, 8000);

  // âœ… OTP Verify before final submit

  // OTP Verify before final submit (form submit handler)
  document.getElementById("checkin-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);
    const phone = (formData.get("phone") || '').trim();
    const otp = (formData.get("otp") || '').trim();

    // Validate phone locally
    if (!phoneRegex.test(phone)) {
      showOtpFlashMessage(
        `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
           Phone must be exactly 10 digits.
         </div>`
      );
      document.getElementById("checkin-phone").focus();
      activateCheckinTab();
      return;
    }

    // Validate OTP locally
    if (!otpRegex.test(otp)) {
      showOtpFlashMessage(
        `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
           OTP is required for check-in .
         </div>`
      );
      document.getElementById("otp-box").style.display = "flex";
      document.getElementById("checkin-otp").focus();
      activateCheckinTab();
      return;
    }

    // If local checks pass, call server to verify OTP
    try {
      const verifyResponse = await fetch("/receptionist/visitors/verify-otp", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ phone: phone, otp: otp })
      });
      const verifyResult = await verifyResponse.json();

      if (verifyResult.ok) {
        // OTP success â€” proceed with normal form submit
        form.submit();
      } else {
        showOtpFlashMessage(
          `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
            ${verifyResult.message || 'Incorrect OTP.'}
          </div>`
        );
        activateCheckinTab();
        document.getElementById("checkin-otp").focus();
      }
    } catch (err) {
      showOtpFlashMessage(
        `<div class="p-3 rounded-lg shadow bg-red-100 border border-red-400 text-red-800">
           Error verifying OTP. Please try again.
         </div>`
      );
      activateCheckinTab();
    }
  });

  function activateCheckinTab() {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById('checkin-tab').classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
    document.querySelector('.tab[data-tab="checkin"]').classList.add('border-secondary', 'text-secondary');
  }
</script>




<script>
  let timeInterval;




  function fillDateTimeOnce() {
    const now = new Date();

    // âœ… Default only once on page load
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    document.getElementById('checkin-date').value = `${year}-${month}-${day}`;

    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('checkin-time').value = `${hours}:${minutes}`;
  }

  document.addEventListener("DOMContentLoaded", () => {
    fillDateTimeOnce();
  });


  function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
    document.querySelector('.tab[data-tab="' + tabName + '"]').classList.add('border-secondary', 'text-secondary');

    if (tabName === "checkin") {
      fillDateTime(true);
    } else {
      clearInterval(timeInterval);
    }
  }

  function activateCheckinTab() {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById('checkin-tab').classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('border-secondary', 'text-secondary'));
    document.querySelector('.tab[data-tab="checkin"]').classList.add('border-secondary', 'text-secondary');

    fillDateTime(true);
  }

  document.addEventListener("DOMContentLoaded", () => {
    fillDateTime();
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const rowsPerPage = 8; // show 8 rows per page
    const tbody = document.getElementById("all-visitors-body");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const prevBtn = document.getElementById("prev-btn-all");
    const nextBtn = document.getElementById("next-btn-all");
    const pageInfo = document.getElementById("page-info-all");

    let currentPage = 1;
    const totalPages = Math.ceil(rows.length / rowsPerPage);

    function showPage(page) {
      const start = (page - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      rows.forEach((row, i) => {
        row.style.display = (i >= start && i < end) ? "" : "none";
      });
      pageInfo.textContent = `Page ${page} of ${totalPages}`;
      prevBtn.disabled = page === 1;
      nextBtn.disabled = page === totalPages;
    }

    prevBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        showPage(currentPage);
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        showPage(currentPage);
      }
    });

    showPage(currentPage); // initialize first page
  });
</script>


<script>
  ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  // Example: { "visitor_id": 5, "name": "Ramesh", "time": "10:30 AM" }

  // Show red dot on bell
  dot.classList.remove("hidden");

  // Add notification item
  const li = document.createElement("li");
  li.className = "p-3 hover:bg-gray-100 cursor-pointer";
  li.innerHTML = `
    <div class="flex justify-between items-center">
      <div>
        <p class="font-medium text-dark">${data.name}</p>
        <p class="text-sm text-gray-500">Meeting at ${data.time}</p>
      </div>
      <span class="text-green-600 font-bold">âœ”</span>
    </div>
  `;
  notificationList.prepend(li);

  // Update table row
  const row = document.querySelector(`[data-visitor-id="${data.visitor_id}"]`);
  if (row) {
    row.classList.remove("hover:bg-gray-50");
    row.classList.add("bg-green-100"); // green highlight

    const statusCell = row.querySelector(".status-cell");
    if (statusCell) {
      statusCell.innerHTML = `<span class="text-green-600 font-bold">âœ” Scheduled</span>`;
    }
  }
};

</script>

{% endblock %}